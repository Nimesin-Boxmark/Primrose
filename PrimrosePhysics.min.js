!function(e){"use strict";function t(e,t,o,n){var a=t&&t.prototype instanceof i?t:i,r=Object.create(a.prototype),s=new u(n||[]);return r._invoke=l(e,o,s),r}function o(e,t,o){try{return{type:"normal",arg:e.call(t,o)}}catch(e){return{type:"throw",arg:e}}}function i(){}function n(){}function a(){}function r(e){["next","throw","return"].forEach(function(t){e[t]=function(e){return this._invoke(t,e)}})}function s(t){function i(e,n,a,r){var s=o(t[e],t,n);if("throw"===s.type)r(s.arg);else{var l=s.arg,p=l.value;return p&&"object"==typeof p&&x.call(p,"__await")?Promise.resolve(p.__await).then(function(e){i("next",e,a,r)},function(e){i("throw",e,a,r)}):Promise.resolve(p).then(function(e){l.value=e,a(l)},r)}}"object"==typeof e.process&&e.process.domain&&(i=e.process.domain.bind(i));var n;this._invoke=function(e,t){function o(){return new Promise(function(o,n){i(e,t,o,n)})}return n=n?n.then(o,o):o()}}function l(e,t,i){var n=E;return function(a,r){if(n==C)throw new Error("Generator is already running");if(n==z){if("throw"===a)throw r;return h()}for(i.method=a,i.arg=r;;){var s=i.delegate;if(s){var l=p(s,i);if(l){if(l===w)continue;return l}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if(n==E)throw n=z,i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);n=C;var d=o(e,t,i);if("normal"===d.type){if(n=i.done?z:A,d.arg===w)continue;return{value:d.arg,done:i.done}}"throw"===d.type&&(n=z,i.method="throw",i.arg=d.arg)}}}function p(e,t){var i=e.iterator[t.method];if(void 0===i){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,p(e,t),"throw"===t.method))return w;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return w}var n=o(i,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,w;var a=n.arg;if(!a)return t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,w;if(a.done)t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0);else return a;return t.delegate=null,w}function d(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function c(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function u(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(d,this),this.reset(!0)}function y(e){if(e){var t=e[v];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function t(){for(;++o<e.length;)if(x.call(e,o))return t.value=e[o],t.done=!1,t;return t.value=void 0,t.done=!0,t};return i.next=i}}return{next:h}}function h(){return{value:void 0,done:!0}}var m=Object.prototype,x=m.hasOwnProperty,g="function"==typeof Symbol?Symbol:{},v=g.iterator||"@@iterator",b=g.asyncIterator||"@@asyncIterator",f=g.toStringTag||"@@toStringTag",B="object"==typeof module,S=e.regeneratorRuntime;if(S)return void(B&&(module.exports=S));S=e.regeneratorRuntime=B?module.exports:{},S.wrap=t;var E="suspendedStart",A="suspendedYield",C="executing",z="completed",w={},R={};R[v]=function(){return this};var q=Object.getPrototypeOf,F=q&&q(q(y([])));F&&F!==m&&x.call(F,v)&&(R=F);var P=a.prototype=i.prototype=Object.create(R);n.prototype=P.constructor=a,a.constructor=n,a[f]=n.displayName="GeneratorFunction",S.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===n||"GeneratorFunction"===(t.displayName||t.name))},S.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,a):(e.__proto__=a,!(f in e)&&(e[f]="GeneratorFunction")),e.prototype=Object.create(P),e},S.awrap=function(e){return{__await:e}},r(s.prototype),s.prototype[b]=function(){return this},S.AsyncIterator=s,S.async=function(e,o,i,n){var a=new s(t(e,o,i,n));return S.isGeneratorFunction(o)?a:a.next().then(function(e){return e.done?e.value:a.next()})},r(P),P[f]="Generator",P[v]=function(){return this},P.toString=function(){return"[object Generator]"},S.keys=function(e){var t=[];for(var o in e)t.push(o);return t.reverse(),function o(){for(;t.length;){var i=t.pop();if(i in e)return o.value=i,o.done=!1,o}return o.done=!0,o}},S.values=y,u.prototype={constructor:u,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(c),!e)for(var t in this)"t"===t.charAt(0)&&x.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0],t=e.completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){function t(t,i){return a.type="throw",a.arg=e,o.next=t,i&&(o.method="next",o.arg=void 0),!!i}if(this.done)throw e;for(var o=this,n=this.tryEntries.length-1;0<=n;--n){var i=this.tryEntries[n],a=i.completion;if("root"===i.tryLoc)return t("end");if(i.tryLoc<=this.prev){var r=x.call(i,"catchLoc"),s=x.call(i,"finallyLoc");if(r&&s){if(this.prev<i.catchLoc)return t(i.catchLoc,!0);if(this.prev<i.finallyLoc)return t(i.finallyLoc)}else if(r){if(this.prev<i.catchLoc)return t(i.catchLoc,!0);}else if(!s)throw new Error("try statement without catch or finally");else if(this.prev<i.finallyLoc)return t(i.finallyLoc)}}},abrupt:function(e,t){for(var o=this.tryEntries.length-1,i;0<=o;--o)if(i=this.tryEntries[o],i.tryLoc<=this.prev&&x.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var n=i;break}n&&("break"===e||"continue"===e)&&n.tryLoc<=t&&t<=n.finallyLoc&&(n=null);var a=n?n.completion:{};return a.type=e,a.arg=t,n?(this.method="next",this.next=n.finallyLoc,w):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),w},finish:function(e){for(var t=this.tryEntries.length-1,o;0<=t;--t)if(o=this.tryEntries[t],o.finallyLoc===e)return this.complete(o.completion,o.afterLoc),c(o),w},catch:function(e){for(var t=this.tryEntries.length-1,o;0<=t;--t)if(o=this.tryEntries[t],o.tryLoc===e){var i=o.completion;if("throw"===i.type){var n=i.arg;c(o)}return n}throw new Error("illegal catch attempt")},delegateYield:function(e,t,o){return this.delegate={iterator:y(e),resultName:t,nextLoc:o},"next"===this.method&&(this.arg=void 0),w}}}("object"==typeof global?global:"object"==typeof window?window:"object"==typeof self?self:this),function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t():"function"==typeof define&&define.amd?define(t):t()}(this,function(){"use strict";function e(){throw new Error("Dynamic requires are not currently supported by rollup-plugin-commonjs")}function t(e,t){var o=t.shift(),i=e[o];i&&i.apply(e,t)}function o(){var e=performance.now(),t=1e-3*(e-d);d=e,l.update(t);for(var o=0,i=0;i<l.bodyIDs.length;++i){var n=l.bodyIDs[i],r=l.bodyDB[n];r.sleepState!==a.Body.SLEEPING&&(p[o+0]=n,p[o+1]=r.position.x,p[o+2]=r.position.y,p[o+3]=r.position.z,p[o+4]=r.quaternion.x,p[o+5]=r.quaternion.y,p[o+6]=r.quaternion.z,p[o+7]=r.quaternion.w,p[o+8]=r.velocity.x,p[o+9]=r.velocity.y,p[o+10]=r.velocity.z,p[o+11]=r.angularVelocity.x,p[o+12]=r.angularVelocity.y,p[o+13]=r.angularVelocity.z,o+=14)}postMessage(p)}var a=function(e,t){return t={exports:{}},e(t,t.exports),t.exports}(function(t){!function(o){t.exports=o()}(function(){var t=Math.floor,o=Number.MAX_VALUE,n=Math.sin,s=Math.PI,r=Math.cos,p=Math.abs,a=Math.max,l=Math.min,c=Math.ceil,d=Math.sqrt,y=Math.pow;return function l(p,t,n){function a(i,o){if(!t[i]){if(!p[i]){var s="function"==typeof e&&e;if(!o&&s)return s(i,!0);if(r)return r(i,!0);throw new Error("Cannot find module '"+i+"'")}var d=t[i]={exports:{}};p[i][0].call(d.exports,function(t){var e=p[i][1][t];return a(e?e:t)},d,d.exports,l,p,t,n)}return t[i].exports}for(var r="function"==typeof e&&e,i=0;i<n.length;i++)a(n[i]);return a}({1:[function(e,t){t.exports={name:"cannon",version:"0.6.2",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/schteppe/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se)",keywords:["cannon.js","cannon","physics","engine","3d"],main:"./build/cannon.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/schteppe/cannon.js.git"},bugs:{url:"https://github.com/schteppe/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(e,t){t.exports={version:e("../package.json").version,AABB:e("./collision/AABB"),ArrayCollisionMatrix:e("./collision/ArrayCollisionMatrix"),Body:e("./objects/Body"),Box:e("./shapes/Box"),Broadphase:e("./collision/Broadphase"),Constraint:e("./constraints/Constraint"),ContactEquation:e("./equations/ContactEquation"),Narrowphase:e("./world/Narrowphase"),ConeTwistConstraint:e("./constraints/ConeTwistConstraint"),ContactMaterial:e("./material/ContactMaterial"),ConvexPolyhedron:e("./shapes/ConvexPolyhedron"),Cylinder:e("./shapes/Cylinder"),DistanceConstraint:e("./constraints/DistanceConstraint"),Equation:e("./equations/Equation"),EventTarget:e("./utils/EventTarget"),FrictionEquation:e("./equations/FrictionEquation"),GSSolver:e("./solver/GSSolver"),GridBroadphase:e("./collision/GridBroadphase"),Heightfield:e("./shapes/Heightfield"),HingeConstraint:e("./constraints/HingeConstraint"),LockConstraint:e("./constraints/LockConstraint"),Mat3:e("./math/Mat3"),Material:e("./material/Material"),NaiveBroadphase:e("./collision/NaiveBroadphase"),ObjectCollisionMatrix:e("./collision/ObjectCollisionMatrix"),Pool:e("./utils/Pool"),Particle:e("./shapes/Particle"),Plane:e("./shapes/Plane"),PointToPointConstraint:e("./constraints/PointToPointConstraint"),Quaternion:e("./math/Quaternion"),Ray:e("./collision/Ray"),RaycastVehicle:e("./objects/RaycastVehicle"),RaycastResult:e("./collision/RaycastResult"),RigidVehicle:e("./objects/RigidVehicle"),RotationalEquation:e("./equations/RotationalEquation"),RotationalMotorEquation:e("./equations/RotationalMotorEquation"),SAPBroadphase:e("./collision/SAPBroadphase"),SPHSystem:e("./objects/SPHSystem"),Shape:e("./shapes/Shape"),Solver:e("./solver/Solver"),Sphere:e("./shapes/Sphere"),SplitSolver:e("./solver/SplitSolver"),Spring:e("./objects/Spring"),Trimesh:e("./shapes/Trimesh"),Vec3:e("./math/Vec3"),Vec3Pool:e("./utils/Vec3Pool"),World:e("./world/World")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":9,"./collision/RaycastResult":10,"./collision/SAPBroadphase":11,"./constraints/ConeTwistConstraint":12,"./constraints/Constraint":13,"./constraints/DistanceConstraint":14,"./constraints/HingeConstraint":15,"./constraints/LockConstraint":16,"./constraints/PointToPointConstraint":17,"./equations/ContactEquation":19,"./equations/Equation":20,"./equations/FrictionEquation":21,"./equations/RotationalEquation":22,"./equations/RotationalMotorEquation":23,"./material/ContactMaterial":24,"./material/Material":25,"./math/Mat3":27,"./math/Quaternion":28,"./math/Vec3":30,"./objects/Body":31,"./objects/RaycastVehicle":32,"./objects/RigidVehicle":33,"./objects/SPHSystem":34,"./objects/Spring":35,"./shapes/Box":37,"./shapes/ConvexPolyhedron":38,"./shapes/Cylinder":39,"./shapes/Heightfield":40,"./shapes/Particle":41,"./shapes/Plane":42,"./shapes/Shape":43,"./shapes/Sphere":44,"./shapes/Trimesh":45,"./solver/GSSolver":46,"./solver/Solver":47,"./solver/SplitSolver":48,"./utils/EventTarget":49,"./utils/Pool":51,"./utils/Vec3Pool":54,"./world/Narrowphase":55,"./world/World":56}],3:[function(e,t){function o(e){e=e||{},this.lowerBound=new i,e.lowerBound&&this.lowerBound.copy(e.lowerBound),this.upperBound=new i,e.upperBound&&this.upperBound.copy(e.upperBound)}var i=e("../math/Vec3"),n=e("../utils/Utils");t.exports=o;var a=new i;o.prototype.setFromPoints=function(e,t,o,n){var r=this.lowerBound,s=this.upperBound,l=o;r.copy(e[0]),l&&l.vmult(r,r),s.copy(r);for(var d=1,i;d<e.length;d++)i=e[d],l&&(l.vmult(i,a),i=a),i.x>s.x&&(s.x=i.x),i.x<r.x&&(r.x=i.x),i.y>s.y&&(s.y=i.y),i.y<r.y&&(r.y=i.y),i.z>s.z&&(s.z=i.z),i.z<r.z&&(r.z=i.z);return t&&(t.vadd(r,r),t.vadd(s,s)),n&&(r.x-=n,r.y-=n,r.z-=n,s.x+=n,s.y+=n,s.z+=n),this},o.prototype.copy=function(e){return this.lowerBound.copy(e.lowerBound),this.upperBound.copy(e.upperBound),this},o.prototype.clone=function(){return new o().copy(this)},o.prototype.extend=function(e){var t=e.lowerBound.x;this.lowerBound.x>t&&(this.lowerBound.x=t);var o=e.upperBound.x;this.upperBound.x<o&&(this.upperBound.x=o);var t=e.lowerBound.y;this.lowerBound.y>t&&(this.lowerBound.y=t);var o=e.upperBound.y;this.upperBound.y<o&&(this.upperBound.y=o);var t=e.lowerBound.z;this.lowerBound.z>t&&(this.lowerBound.z=t);var o=e.upperBound.z;this.upperBound.z<o&&(this.upperBound.z=o)},o.prototype.overlaps=function(e){var t=this.lowerBound,o=this.upperBound,i=e.lowerBound,n=e.upperBound;return(i.x<=o.x&&o.x<=n.x||t.x<=n.x&&n.x<=o.x)&&(i.y<=o.y&&o.y<=n.y||t.y<=n.y&&n.y<=o.y)&&(i.z<=o.z&&o.z<=n.z||t.z<=n.z&&n.z<=o.z)},o.prototype.contains=function(e){var t=this.lowerBound,o=this.upperBound,i=e.lowerBound,n=e.upperBound;return t.x<=i.x&&o.x>=n.x&&t.y<=i.y&&o.y>=n.y&&t.z<=i.z&&o.z>=n.z},o.prototype.getCorners=function(t,o,i,n,a,e,r,s){var p=this.lowerBound,l=this.upperBound;t.copy(p),o.set(l.x,p.y,p.z),i.set(l.x,l.y,p.z),n.set(p.x,l.y,l.z),a.set(l.x,p.y,p.z),e.set(p.x,l.y,p.z),r.set(p.x,p.y,l.z),s.copy(l)};var r=[new i,new i,new i,new i,new i,new i,new i,new i];o.prototype.toLocalFrame=function(t,o){var n=r,s=n[0],a=n[1],l=n[2],p=n[3],d=n[4],e=n[5],c=n[6],u=n[7];this.getCorners(s,a,l,p,d,e,c,u);for(var y=0,i;8!==y;y++)i=n[y],t.pointToLocal(i,i);return o.setFromPoints(n)},o.prototype.toWorldFrame=function(t,o){var n=r,s=n[0],a=n[1],l=n[2],p=n[3],d=n[4],e=n[5],c=n[6],u=n[7];this.getCorners(s,a,l,p,d,e,c,u);for(var y=0,i;8!==y;y++)i=n[y],t.pointToWorld(i,i);return o.setFromPoints(n)}},{"../math/Vec3":30,"../utils/Utils":53}],4:[function(e,t){function o(){this.matrix=[]}t.exports=o,o.prototype.get=function(e,t){if(e=e.index,t=t.index,t>e){var o=t;t=e,e=o}return this.matrix[(e*(e+1)>>1)+t-1]},o.prototype.set=function(e,t,o){if(e=e.index,t=t.index,t>e){var i=t;t=e,e=i}this.matrix[(e*(e+1)>>1)+t-1]=o?1:0},o.prototype.reset=function(){for(var e=0,t=this.matrix.length;e!==t;e++)this.matrix[e]=0},o.prototype.setNumObjects=function(e){this.matrix.length=e*(e-1)>>1}},{}],5:[function(e,t){function o(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}var i=e("../objects/Body"),n=e("../math/Vec3"),a=e("../math/Quaternion"),r=e("../shapes/Shape"),s=e("../shapes/Plane");t.exports=o,o.prototype.collisionPairs=function(){throw new Error("collisionPairs not implemented for this BroadPhase class!")};var l=i.STATIC|i.KINEMATIC;o.prototype.needBroadphaseCollision=function(e,t){return 0==(e.collisionFilterGroup&t.collisionFilterMask)||0==(t.collisionFilterGroup&e.collisionFilterMask)?!1:(0!=(e.type&l)||e.sleepState===i.SLEEPING)&&(0!=(t.type&l)||t.sleepState===i.SLEEPING)?!1:!0},o.prototype.intersectionTest=function(e,t,o,i){this.useBoundingBoxes?this.doBoundingBoxBroadphase(e,t,o,i):this.doBoundingSphereBroadphase(e,t,o,i)};var p=new n,d=new n,c=new a,u=new n;o.prototype.doBoundingSphereBroadphase=function(e,t,o,i){var n=p;t.position.vsub(e.position,n);var a=y(e.boundingRadius+t.boundingRadius,2),r=n.norm2();r<a&&(o.push(e),i.push(t))},o.prototype.doBoundingBoxBroadphase=function(e,t,o,i){e.aabbNeedsUpdate&&e.computeAABB(),t.aabbNeedsUpdate&&t.computeAABB(),e.aabb.overlaps(t.aabb)&&(o.push(e),i.push(t))};var h={keys:[]},m=[],x=[];o.prototype.makePairsUnique=function(e,o){for(var n=h,t=m,a=x,r=e.length,s=0;s!==r;s++)t[s]=e[s],a[s]=o[s];e.length=0,o.length=0;for(var s=0;s!==r;s++){var i=t[s].id,l=a[s].id,p=i<l?i+","+l:l+","+i;n[p]=s,n.keys.push(p)}for(var s=0;s!==n.keys.length;s++){var p=n.keys.pop(),d=n[p];e.push(t[d]),o.push(a[d]),delete n[p]}},o.prototype.setWorld=function(){};var g=new n;o.boundingSphereCheck=function(e,t){var o=g;return e.position.vsub(t.position,o),y(e.shape.boundingSphereRadius+t.shape.boundingSphereRadius,2)>o.norm2()},o.prototype.aabbQuery=function(){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Plane":42,"../shapes/Shape":43}],6:[function(e,t){function o(e,t,o,a,s){n.apply(this),this.nx=o||10,this.ny=a||10,this.nz=s||10,this.aabbMin=e||new r(100,100,100),this.aabbMax=t||new r(-100,-100,-100);var l=this.nx*this.ny*this.nz;if(0>=l)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=l,this.binLengths.length=l;for(var p=0;p<l;p++)this.bins[p]=[],this.binLengths[p]=0}t.exports=o;var n=e("./Broadphase"),r=e("../math/Vec3"),s=e("../shapes/Shape");o.prototype=new n,o.prototype.constructor=o;var i=new r,p=new r;o.prototype.collisionPairs=function(e,t,o){function n(e,t,o,i,n,a,r){var s=0|(e-w)*F,l=0|(t-R)*P,p=0|(o-q)*T,d=Y((i-w)*F),c=Y((n-R)*P),u=Y((a-q)*T);0>s?s=0:s>=g&&(s=g-1),0>l?l=0:l>=v&&(l=v-1),0>p?p=0:p>=b&&(p=b-1),0>d?d=0:d>=g&&(d=g-1),0>c?c=0:c>=v&&(c=v-1),0>u?u=0:u>=b&&(u=b-1),s*=f,l*=B,p*=S,d*=f,c*=B,u*=S;for(var y=s;y<=d;y+=f)for(var h=l;h<=c;h+=B)for(var m=p,x;m<=u;m+=S)x=y+h+m,D[x][H[x]++]=r}for(var p=e.numObjects(),u=e.bodies,h=this.aabbMax,m=this.aabbMin,g=this.nx,v=this.ny,b=this.nz,f=v*b,B=b,S=1,E=h.x,A=h.y,C=h.z,w=m.x,R=m.y,q=m.z,F=g/(E-w),P=v/(A-R),T=b/(C-q),V=(E-w)/g,j=(A-R)/v,I=(C-q)/b,L=0.5*d(V*V+j*j+I*I),W=s.types,N=W.SPHERE,M=W.PLANE,k=W.BOX,O=W.COMPOUND,_=W.CONVEXPOLYHEDRON,D=this.bins,H=this.binLengths,U=this.bins.length,G=0;G!==U;G++)H[G]=0;for(var Y=c,m=l,h=a,G=0;G!==p;G++){var Q=u[G],X=Q.shape;switch(X.type){case N:var Z=Q.position.x,x=Q.position.y,y=Q.position.z,z=X.radius;n(Z-z,x-z,y-z,Z+z,x+z,y+z,Q);break;case M:X.worldNormalNeedsUpdate&&X.computeWorldNormal(Q.quaternion);var r=X.worldNormal,K=w+0.5*V-Q.position.x,J=R+0.5*j-Q.position.y,$=q+0.5*I-Q.position.z,ee=i;ee.set(K,J,$);for(var te=0,oe=0;te!==g;te++,oe+=f,ee.y=J,ee.x+=V)for(var ie=0,ne=0;ie!==v;ie++,ne+=B,ee.z=$,ee.y+=j)for(var ae=0,re=0;ae!==b;ae++,re+=S,ee.z+=I)if(ee.dot(r)<L){var se=oe+ne+re;D[se][H[se]++]=Q}break;default:Q.aabbNeedsUpdate&&Q.computeAABB(),n(Q.aabb.lowerBound.x,Q.aabb.lowerBound.y,Q.aabb.lowerBound.z,Q.aabb.upperBound.x,Q.aabb.upperBound.y,Q.aabb.upperBound.z,Q);}}for(var G=0,le;G!==U;G++)if(le=H[G],1<le)for(var pe=D[G],te=0,Q;te!==le;te++){Q=pe[te];for(var ie=0,de;ie!==te;ie++)de=pe[ie],this.needBroadphaseCollision(Q,de)&&this.intersectionTest(Q,de,t,o)}this.makePairsUnique(t,o)}},{"../math/Vec3":30,"../shapes/Shape":43,"./Broadphase":5}],7:[function(e,t){function o(){i.apply(this)}t.exports=o;var i=e("./Broadphase"),n=e("./AABB");o.prototype=new i,o.prototype.constructor=o,o.prototype.collisionPairs=function(e,t,o){var a=e.bodies,r=a.length,n,i,s,l;for(n=0;n!==r;n++)for(i=0;i!==n;i++)(s=a[n],l=a[i],!!this.needBroadphaseCollision(s,l))&&this.intersectionTest(s,l,t,o)};new n;o.prototype.aabbQuery=function(e,t,o){o=o||[];for(var n=0,i;n<e.bodies.length;n++)i=e.bodies[n],i.aabbNeedsUpdate&&i.computeAABB(),i.aabb.overlaps(t)&&o.push(i);return o}},{"./AABB":3,"./Broadphase":5}],8:[function(e,t){function o(){this.matrix={}}t.exports=o,o.prototype.get=function(e,t){if(e=e.id,t=t.id,t>e){var o=t;t=e,e=o}return e+"-"+t in this.matrix},o.prototype.set=function(e,t,o){if(e=e.id,t=t.id,t>e){var i=t;t=e,e=i}o?this.matrix[e+"-"+t]=!0:delete this.matrix[e+"-"+t]},o.prototype.reset=function(){this.matrix={}},o.prototype.setNumObjects=function(){}},{}],9:[function(e,t){function o(e,t){this.from=e?e.clone():new r,this.to=t?t.clone():new r,this._direction=new r,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=o.ANY,this.result=new x,this.hasHit=!1,this.callback=function(){}}function n(e,t,o,i){i.vsub(t,Q),o.vsub(t,S),e.vsub(t,E);var n=Q.dot(Q),a=Q.dot(S),r=Q.dot(E),s=S.dot(S),l=S.dot(E),p,d;return 0<=(p=s*r-a*l)&&0<=(d=n*l-a*r)&&p+d<n*s-a*a}function i(e,t,o){o.vsub(e,Q);var i=Q.dot(t);t.mult(i,X),X.vadd(e,X);var n=o.distanceTo(X);return n}t.exports=o;var r=e("../math/Vec3"),s=e("../math/Quaternion"),u=e("../math/Transform"),h=e("../shapes/ConvexPolyhedron"),m=e("../shapes/Box"),x=e("../collision/RaycastResult"),g=e("../shapes/Shape"),v=e("../collision/AABB");o.prototype.constructor=o,o.CLOSEST=1,o.ANY=2,o.ALL=4;var f=new v,B=[];o.prototype.intersectWorld=function(e,t){return this.mode=t.mode||o.ANY,this.result=t.result||new x,this.skipBackfaces=!!t.skipBackfaces,this.collisionFilterMask="undefined"==typeof t.collisionFilterMask?-1:t.collisionFilterMask,this.collisionFilterGroup="undefined"==typeof t.collisionFilterGroup?-1:t.collisionFilterGroup,t.from&&this.from.copy(t.from),t.to&&this.to.copy(t.to),this.callback=t.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(f),B.length=0,e.broadphase.aabbQuery(e,f,B),this.intersectBodies(B),this.hasHit};var S=new r,E=new r;o.pointInTriangle=n;var A=new r,C=new s;o.prototype.intersectBody=function(e,t){t&&(this.result=t,this._updateDirection());var o=this.checkCollisionResponse;if((!o||e.collisionResponse)&&0!=(this.collisionFilterGroup&e.collisionFilterMask)&&0!=(e.collisionFilterGroup&this.collisionFilterMask))for(var n=A,a=C,r=0,i=e.shapes.length,s;r<i&&!((s=e.shapes[r],!o||s.collisionResponse)&&(e.quaternion.mult(e.shapeOrientations[r],a),e.quaternion.vmult(e.shapeOffsets[r],n),n.vadd(e.position,n),this.intersectShape(s,a,n,e),this.result._shouldStop));r++);},o.prototype.intersectBodies=function(e,t){t&&(this.result=t,this._updateDirection());for(var o=0,i=e.length;!this.result._shouldStop&&o<i;o++)this.intersectBody(e[o])},o.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction),this._direction.normalize()},o.prototype.intersectShape=function(e,t,o,n){var a=this.from,r=i(a,this._direction,o);if(!(r>e.boundingSphereRadius)){var s=this[e.type];s&&s.call(this,e,t,o,n)}};var z=new r,w=new r,R=new r,F=new r,P=new r,b=new r,c=new r,q=new x;o.prototype.intersectBox=function(e,t,o,i){return this.intersectConvex(e.convexPolyhedronRepresentation,t,o,i)},o.prototype[g.types.BOX]=o.prototype.intersectBox,o.prototype.intersectPlane=function(e,o,i,n){var a=this.from,s=this.to,l=this._direction,d=new r(0,0,1);o.vmult(d,d);var c=new r;a.vsub(i,c);var u=c.dot(d);s.vsub(i,c);var y=c.dot(d);if(!(0<u*y)&&!(a.distanceTo(s)<u)){var h=d.dot(l);if(!(p(h)<this.precision)){var m=new r,x=new r,g=new r;a.vsub(i,m);var v=-d.dot(m)/h;l.scale(v,x),a.vadd(x,g),this.reportIntersection(d,g,e,n,-1)}}},o.prototype[g.types.PLANE]=o.prototype.intersectPlane,o.prototype.getAABB=function(e){var t=this.to,o=this.from;e.lowerBound.x=l(t.x,o.x),e.lowerBound.y=l(t.y,o.y),e.lowerBound.z=l(t.z,o.z),e.upperBound.x=a(t.x,o.x),e.upperBound.y=a(t.y,o.y),e.upperBound.z=a(t.z,o.z)};var T={faceList:[0]};o.prototype.intersectHeightfield=function(e,t,n,a){var s=e.data,l=e.elementSize,p=new r,d=new o(this.from,this.to);u.pointToLocalFrame(n,t,d.from,d.from),u.pointToLocalFrame(n,t,d.to,d.to);var c=[],y=null,h=null,m=null,x=null,g=e.getIndexOfPosition(d.from.x,d.from.y,c,!1);if(g&&(y=c[0],h=c[1],m=c[0],x=c[1]),g=e.getIndexOfPosition(d.to.x,d.to.y,c,!1),g&&((null===y||c[0]<y)&&(y=c[0]),(null===m||c[0]>m)&&(m=c[0]),(null===h||c[1]<h)&&(h=c[1]),(null===x||c[1]>x)&&(x=c[1])),null!==y){var v=[];e.getRectMinMax(y,h,m,x,v);for(var b=v[0],f=v[1],B=y;B<=m;B++)for(var i=h;i<=x;i++){if(this.result._shouldStop)return;if(e.getConvexTrianglePillar(B,i,!1),u.pointToWorldFrame(n,t,e.pillarOffset,p),this.intersectConvex(e.pillarConvex,t,p,a,T),this.result._shouldStop)return;e.getConvexTrianglePillar(B,i,!0),u.pointToWorldFrame(n,t,e.pillarOffset,p),this.intersectConvex(e.pillarConvex,t,p,a,T)}}},o.prototype[g.types.HEIGHTFIELD]=o.prototype.intersectHeightfield;var V=new r,j=new r;o.prototype.intersectSphere=function(e,t,o,i){var n=this.from,s=this.to,l=e.radius,r=y(s.x-n.x,2)+y(s.y-n.y,2)+y(s.z-n.z,2),a=2*((s.x-n.x)*(n.x-o.x)+(s.y-n.y)*(n.y-o.y)+(s.z-n.z)*(n.z-o.z)),p=y(n.x-o.x,2)+y(n.y-o.y,2)+y(n.z-o.z,2)-y(l,2),c=y(a,2)-4*r*p,u=V,h=j;if(!(0>c))if(0==c)n.lerp(s,c,u),u.vsub(o,h),h.normalize(),this.reportIntersection(h,u,e,i,-1);else{var m=(-a-d(c))/(2*r),x=(-a+d(c))/(2*r);if(0<=m&&1>=m&&(n.lerp(s,m,u),u.vsub(o,h),h.normalize(),this.reportIntersection(h,u,e,i,-1)),this.result._shouldStop)return;0<=x&&1>=x&&(n.lerp(s,x,u),u.vsub(o,h),h.normalize(),this.reportIntersection(h,u,e,i,-1))}},o.prototype[g.types.SPHERE]=o.prototype.intersectSphere;var I=new r,L=new r,W=new r,M=new r;o.prototype.intersectConvex=function(e,t,o,a,r){for(var s=I,l=M,d=r&&r.faceList||null,c=e.faces,u=e.vertices,y=e.faceNormals,h=this._direction,m=this.from,g=this.to,v=m.distanceTo(g),f=d?d.length:c.length,B=this.result,S=0;!B._shouldStop&&S<f;S++){var E=d?d[S]:S,A=c[E],C=y[E],z=t,w=o;l.copy(u[A[0]]),z.vmult(l,l),l.vadd(w,l),l.vsub(m,l),z.vmult(C,s);var x=h.dot(s);if(!(p(x)<this.precision)){var q=s.dot(l)/x;if(!(0>q)){h.mult(q,R),R.vadd(m,R),F.copy(u[A[0]]),z.vmult(F,F),w.vadd(F,F);for(var T=1;!B._shouldStop&&T<A.length-1;T++){P.copy(u[A[T]]),b.copy(u[A[T+1]]),z.vmult(P,P),z.vmult(b,b),w.vadd(P,P),w.vadd(b,b);var i=R.distanceTo(m);(n(R,F,P,b)||n(R,P,F,b))&&!(i>v)&&this.reportIntersection(s,R,e,a,E)}}}}},o.prototype[g.types.CONVEXPOLYHEDRON]=o.prototype.intersectConvex;var k=new r,O=new r,_=new r,D=new r,H=new r,U=new r,N=new v,G=[],Y=new u;o.prototype.intersectTrimesh=function(e,t,o,a,r){var s=k,l=G,p=Y,d=M,c=O,y=_,h=D,m=U,x=H,g=r&&r.faceList||null,v=e.indices,f=e.vertices,B=e.faceNormals,S=this.from,E=this.to,A=this._direction;p.position.copy(o),p.quaternion.copy(t),u.vectorToLocalFrame(o,t,A,c),u.pointToLocalFrame(o,t,S,y),u.pointToLocalFrame(o,t,E,h);var C=y.distanceSquared(h);e.tree.rayQuery(this,p,l);for(var z=0,i=l.length,w;!this.result._shouldStop&&z!==i;z++){w=l[z],e.getNormal(w,s),e.getVertex(v[3*w],F),F.vsub(y,d);var q=c.dot(s),T=s.dot(d)/q;if(!(0>T)){c.scale(T,R),R.vadd(y,R),e.getVertex(v[3*w+1],P),e.getVertex(v[3*w+2],b);var V=R.distanceSquared(y);(n(R,P,F,b)||n(R,F,P,b))&&!(V>C)&&(u.vectorToWorldFrame(t,s,x),u.pointToWorldFrame(o,t,R,m),this.reportIntersection(x,m,e,a,w))}}l.length=0},o.prototype[g.types.TRIMESH]=o.prototype.intersectTrimesh,o.prototype.reportIntersection=function(e,t,i,n,a){var r=this.from,s=this.to,l=r.distanceTo(t),p=this.result;if(!(this.skipBackfaces&&0<e.dot(this._direction)))switch(p.hitFaceIndex="undefined"==typeof a?-1:a,this.mode){case o.ALL:this.hasHit=!0,p.set(r,s,e,t,i,n,l),p.hasHit=!0,this.callback(p);break;case o.CLOSEST:(l<p.distance||!p.hasHit)&&(this.hasHit=!0,p.hasHit=!0,p.set(r,s,e,t,i,n,l));break;case o.ANY:this.hasHit=!0,p.hasHit=!0,p.set(r,s,e,t,i,n,l),p._shouldStop=!0;}};var Q=new r,X=new r},{"../collision/AABB":3,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/Box":37,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43}],10:[function(e,t){function o(){this.rayFromWorld=new i,this.rayToWorld=new i,this.hitNormalWorld=new i,this.hitPointWorld=new i,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}var i=e("../math/Vec3");t.exports=o,o.prototype.reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1},o.prototype.abort=function(){this._shouldStop=!0},o.prototype.set=function(e,t,o,i,n,a,r){this.rayFromWorld.copy(e),this.rayToWorld.copy(t),this.hitNormalWorld.copy(o),this.hitPointWorld.copy(i),this.shape=n,this.body=a,this.distance=r}},{"../math/Vec3":30}],11:[function(e,t){function o(e){n.apply(this),this.axisList=[],this.world=null,this.axisIndex=0;var t=this.axisList;this._addBodyHandler=function(o){t.push(o.body)},this._removeBodyHandler=function(o){var e=t.indexOf(o.body);-1!==e&&t.splice(e,1)},e&&this.setWorld(e)}var i=e("../shapes/Shape"),n=e("../collision/Broadphase");t.exports=o,o.prototype=new n,o.prototype.setWorld=function(e){this.axisList.length=0;for(var t=0;t<e.bodies.length;t++)this.axisList.push(e.bodies[t]);e.removeEventListener("addBody",this._addBodyHandler),e.removeEventListener("removeBody",this._removeBodyHandler),e.addEventListener("addBody",this._addBodyHandler),e.addEventListener("removeBody",this._removeBodyHandler),this.world=e,this.dirty=!0},o.insertionSortX=function(e){for(var t=1,o=e.length,i;t<o;t++){i=e[t];for(var n=t-1;0<=n&&!(e[n].aabb.lowerBound.x<=i.aabb.lowerBound.x);n--)e[n+1]=e[n];e[n+1]=i}return e},o.insertionSortY=function(e){for(var t=1,o=e.length,i;t<o;t++){i=e[t];for(var n=t-1;0<=n&&!(e[n].aabb.lowerBound.y<=i.aabb.lowerBound.y);n--)e[n+1]=e[n];e[n+1]=i}return e},o.insertionSortZ=function(e){for(var t=1,o=e.length,i;t<o;t++){i=e[t];for(var n=t-1;0<=n&&!(e[n].aabb.lowerBound.z<=i.aabb.lowerBound.z);n--)e[n+1]=e[n];e[n+1]=i}return e},o.prototype.collisionPairs=function(e,t,n){var a=this.axisList,r=a.length,s=this.axisIndex,l,i;for(this.dirty&&(this.sortList(),this.dirty=!1),l=0;l!==r;l++){var p=a[l];for(i=l+1;i<r;i++){var d=a[i];if(this.needBroadphaseCollision(p,d)){if(!o.checkBounds(p,d,s))break;this.intersectionTest(p,d,t,n)}}}},o.prototype.sortList=function(){for(var e=this.axisList,t=this.axisIndex,n=e.length,a=0,i;a!==n;a++)i=e[a],i.aabbNeedsUpdate&&i.computeAABB();0===t?o.insertionSortX(e):1===t?o.insertionSortY(e):2===t&&o.insertionSortZ(e)},o.checkBounds=function(e,t,o){var i,n;0===o?(i=e.position.x,n=t.position.x):1===o?(i=e.position.y,n=t.position.y):2===o&&(i=e.position.z,n=t.position.z);var a=e.boundingRadius,r=t.boundingRadius,s=i+a,l=n-r;return l<s},o.prototype.autoDetectAxis=function(){for(var e=0,t=0,o=0,n=0,a=0,r=0,s=this.axisList,l=s.length,p=1/l,d=0;d!==l;d++){var i=s[d],c=i.position.x;e+=c,t+=c*c;var u=i.position.y;o+=u,n+=u*u;var y=i.position.z;a+=y,r+=y*y}var h=t-e*e*p,m=n-o*o*p,x=r-a*a*p;this.axisIndex=h>m?h>x?0:2:m>x?1:2},o.prototype.aabbQuery=function(e,t,o){o=o||[],this.dirty&&(this.sortList(),this.dirty=!1);var n=this.axisIndex,a="x";1===n&&(a="y"),2===n&&(a="z");for(var r=this.axisList,s=t.lowerBound[a],l=t.upperBound[a],p=0,i;p<r.length;p++)i=r[p],i.aabbNeedsUpdate&&i.computeAABB(),i.aabb.overlaps(t)&&o.push(i);return o}},{"../collision/Broadphase":5,"../shapes/Shape":43}],12:[function(e,t){function o(e,o,i){i=i||{};var s="undefined"==typeof i.maxForce?1e6:i.maxForce,p=i.pivotA?i.pivotA.clone():new l,d=i.pivotB?i.pivotB.clone():new l;this.axisA=i.axisA?i.axisA.clone():new l,this.axisB=i.axisB?i.axisB.clone():new l,n.call(this,e,p,o,d,s),this.collideConnected=!!i.collideConnected,this.angle="undefined"==typeof i.angle?0:i.angle;var u=this.coneEquation=new a(e,o,i),c=this.twistEquation=new r(e,o,i);this.twistAngle="undefined"==typeof i.twistAngle?0:i.twistAngle,u.maxForce=0,u.minForce=-s,c.maxForce=0,c.minForce=-s,this.equations.push(u,c)}t.exports=o;var i=e("./Constraint"),n=e("./PointToPointConstraint"),a=e("../equations/ConeEquation"),r=e("../equations/RotationalEquation"),s=e("../equations/ContactEquation"),l=e("../math/Vec3");o.prototype=new n,o.constructor=o;var p=new l,d=new l;o.prototype.update=function(){var e=this.bodyA,t=this.bodyB,o=this.coneEquation,i=this.twistEquation;n.prototype.update.call(this),e.vectorToWorldFrame(this.axisA,o.axisA),t.vectorToWorldFrame(this.axisB,o.axisB),this.axisA.tangents(i.axisA,i.axisA),e.vectorToWorldFrame(i.axisA,i.axisA),this.axisB.tangents(i.axisB,i.axisB),t.vectorToWorldFrame(i.axisB,i.axisB),o.angle=this.angle,i.maxAngle=this.twistAngle}},{"../equations/ConeEquation":18,"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],13:[function(e,t){function o(e,t,n){n=i.defaults(n,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=e,this.bodyB=t,this.id=o.idCounter++,this.collideConnected=n.collideConnected,n.wakeUpBodies&&(e&&e.wakeUp(),t&&t.wakeUp())}t.exports=o;var i=e("../utils/Utils");o.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},o.prototype.enable=function(){for(var e=this.equations,t=0;t<e.length;t++)e[t].enabled=!0},o.prototype.disable=function(){for(var e=this.equations,t=0;t<e.length;t++)e[t].enabled=!1},o.idCounter=0},{"../utils/Utils":53}],14:[function(e,t){function o(e,t,o,a){i.call(this,e,t),"undefined"==typeof o&&(o=e.position.distanceTo(t.position)),"undefined"==typeof a&&(a=1e6),this.distance=o;var r=this.distanceEquation=new n(e,t);this.equations.push(r),r.minForce=-a,r.maxForce=a}t.exports=o;var i=e("./Constraint"),n=e("../equations/ContactEquation");o.prototype=new i,o.prototype.update=function(){var e=this.bodyA,t=this.bodyB,o=this.distanceEquation,i=0.5*this.distance,n=o.ni;t.position.vsub(e.position,n),n.normalize(),n.mult(i,o.ri),n.mult(-i,o.rj)}},{"../equations/ContactEquation":19,"./Constraint":13}],15:[function(e,t){function o(e,t,o){o=o||{};var i="undefined"==typeof o.maxForce?1e6:o.maxForce,s=o.pivotA?o.pivotA.clone():new l,p=o.pivotB?o.pivotB.clone():new l;n.call(this,e,s,t,p,i);var d=this.axisA=o.axisA?o.axisA.clone():new l(1,0,0);d.normalize();var c=this.axisB=o.axisB?o.axisB.clone():new l(1,0,0);c.normalize();var u=this.rotationalEquation1=new a(e,t,o),y=this.rotationalEquation2=new a(e,t,o),h=this.motorEquation=new r(e,t,i);h.enabled=!1,this.equations.push(u,y,h)}t.exports=o;var i=e("./Constraint"),n=e("./PointToPointConstraint"),a=e("../equations/RotationalEquation"),r=e("../equations/RotationalMotorEquation"),s=e("../equations/ContactEquation"),l=e("../math/Vec3");o.prototype=new n,o.constructor=o,o.prototype.enableMotor=function(){this.motorEquation.enabled=!0},o.prototype.disableMotor=function(){this.motorEquation.enabled=!1},o.prototype.setMotorSpeed=function(e){this.motorEquation.targetVelocity=e},o.prototype.setMotorMaxForce=function(e){this.motorEquation.maxForce=e,this.motorEquation.minForce=-e};var p=new l,d=new l;o.prototype.update=function(){var e=this.bodyA,t=this.bodyB,o=this.motorEquation,i=this.rotationalEquation1,a=this.rotationalEquation2,r=p,s=d,l=this.axisA,c=this.axisB;n.prototype.update.call(this),e.quaternion.vmult(l,r),t.quaternion.vmult(c,s),r.tangents(i.axisA,a.axisA),i.axisB.copy(s),a.axisB.copy(s),this.motorEquation.enabled&&(e.quaternion.vmult(this.axisA,o.axisA),t.quaternion.vmult(this.axisB,o.axisB))}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],16:[function(e,t){function o(e,t,o){o=o||{};var i="undefined"==typeof o.maxForce?1e6:o.maxForce,r=new l,s=new l,p=new l;e.position.vadd(t.position,p),p.scale(0.5,p),t.pointToLocalFrame(p,s),e.pointToLocalFrame(p,r),n.call(this,e,r,t,s,i);var d=this.rotationalEquation1=new a(e,t,o),c=this.rotationalEquation2=new a(e,t,o),u=this.rotationalEquation3=new a(e,t,o);this.equations.push(d,c,u)}t.exports=o;var i=e("./Constraint"),n=e("./PointToPointConstraint"),a=e("../equations/RotationalEquation"),r=e("../equations/RotationalMotorEquation"),s=e("../equations/ContactEquation"),l=e("../math/Vec3");o.prototype=new n,o.constructor=o;var p=new l,d=new l;o.prototype.update=function(){var e=this.bodyA,t=this.bodyB,o=this.motorEquation,i=this.rotationalEquation1,a=this.rotationalEquation2,r=this.rotationalEquation3;n.prototype.update.call(this),e.vectorToWorldFrame(l.UNIT_X,i.axisA),t.vectorToWorldFrame(l.UNIT_Y,i.axisB),e.vectorToWorldFrame(l.UNIT_Y,a.axisA),t.vectorToWorldFrame(l.UNIT_Z,a.axisB),e.vectorToWorldFrame(l.UNIT_Z,r.axisA),t.vectorToWorldFrame(l.UNIT_X,r.axisB)}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],17:[function(e,t){function o(e,t,o,r,s){i.call(this,e,o),s="undefined"==typeof s?1e6:s,this.pivotA=t?t.clone():new a,this.pivotB=r?r.clone():new a;var l=this.equationX=new n(e,o),p=this.equationY=new n(e,o),d=this.equationZ=new n(e,o);this.equations.push(l,p,d),l.minForce=p.minForce=d.minForce=-s,l.maxForce=p.maxForce=d.maxForce=s,l.ni.set(1,0,0),p.ni.set(0,1,0),d.ni.set(0,0,1)}t.exports=o;var i=e("./Constraint"),n=e("../equations/ContactEquation"),a=e("../math/Vec3");o.prototype=new i,o.prototype.update=function(){var e=this.bodyA,t=this.bodyB,o=this.equationX,i=this.equationY,n=this.equationZ;e.quaternion.vmult(this.pivotA,o.ri),t.quaternion.vmult(this.pivotB,o.rj),i.ri.copy(o.ri),i.rj.copy(o.rj),n.ri.copy(o.ri),n.rj.copy(o.rj)}},{"../equations/ContactEquation":19,"../math/Vec3":30,"./Constraint":13}],18:[function(e,t){function o(e,t,o){o=o||{};var n="undefined"==typeof o.maxForce?1e6:o.maxForce;a.call(this,e,t,-n,n),this.axisA=o.axisA?o.axisA.clone():new i(1,0,0),this.axisB=o.axisB?o.axisB.clone():new i(0,1,0),this.angle="undefined"==typeof o.angle?0:o.angle}t.exports=o;var i=e("../math/Vec3"),n=e("../math/Mat3"),a=e("./Equation");o.prototype=new a,o.prototype.constructor=o;var s=new i,l=new i;o.prototype.computeB=function(e){var t=this.a,o=this.b,i=this.axisA,n=this.axisB,a=s,p=l,d=this.jacobianElementA,c=this.jacobianElementB;i.cross(n,a),n.cross(i,p),d.rotational.copy(p),c.rotational.copy(a);var u=r(this.angle)-i.dot(n),y=this.computeGW(),h=this.computeGiMf();return-u*t-y*o-e*h}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],19:[function(e,t){function o(e,t,o){o="undefined"==typeof o?1e6:o,i.call(this,e,t,0,o),this.restitution=0,this.ri=new n,this.rj=new n,this.ni=new n}t.exports=o;var i=e("./Equation"),n=e("../math/Vec3"),a=e("../math/Mat3");o.prototype=new i,o.prototype.constructor=o;var r=new n,s=new n,l=new n;o.prototype.computeB=function(e){var t=this.a,o=this.b,i=this.bi,a=this.bj,p=this.ri,d=this.rj,c=r,u=s,y=i.velocity,h=i.angularVelocity,m=i.force,x=i.torque,v=a.velocity,b=a.angularVelocity,f=a.force,B=a.torque,S=l,E=this.jacobianElementA,A=this.jacobianElementB,C=this.ni;p.cross(C,c),d.cross(C,u),C.negate(E.spatial),c.negate(E.rotational),A.spatial.copy(C),A.rotational.copy(u),S.copy(a.position),S.vadd(d,S),S.vsub(i.position,S),S.vsub(p,S);var n=C.dot(S),z=this.restitution+1,w=z*v.dot(C)-z*y.dot(C)+b.dot(u)-h.dot(c),R=this.computeGiMf();return-n*t-w*o-e*R};var p=new n,d=new n,c=new n,u=new n,y=new n;o.prototype.getImpactVelocityAlongNormal=function(){var e=p,t=d,o=c,i=u,n=y;return this.bi.position.vadd(this.ri,o),this.bj.position.vadd(this.rj,i),this.bi.getVelocityAtWorldPoint(o,e),this.bj.getVelocityAtWorldPoint(i,t),e.vsub(t,n),this.ni.dot(n)}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],20:[function(e,t){function o(e,t,n,a){this.id=o.id++,this.minForce="undefined"==typeof n?-1e6:n,this.maxForce="undefined"==typeof a?1e6:a,this.bi=e,this.bj=t,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new i,this.jacobianElementB=new i,this.enabled=!0,this.setSpookParams(1e7,4,1/60)}t.exports=o;var i=e("../math/JacobianElement"),n=e("../math/Vec3");o.prototype.constructor=o,o.id=0,o.prototype.setSpookParams=function(e,t,o){var i=t,n=o;this.a=4/(n*(1+4*i)),this.b=4*i/(1+4*i),this.eps=4/(n*n*e*(1+4*i))},o.prototype.computeB=function(e,t,o){var i=this.computeGW(),n=this.computeGq(),a=this.computeGiMf();return-n*e-i*t-a*o},o.prototype.computeGq=function(){var e=this.jacobianElementA,t=this.jacobianElementB,o=this.bi,i=this.bj,n=o.position,a=i.position;return e.spatial.dot(n)+t.spatial.dot(a)};var a=new n;o.prototype.computeGW=function(){var e=this.jacobianElementA,t=this.jacobianElementB,o=this.bi,i=this.bj,n=o.velocity,r=i.velocity,s=o.angularVelocity||a,l=i.angularVelocity||a;return e.multiplyVectors(n,s)+t.multiplyVectors(r,l)},o.prototype.computeGWlambda=function(){var e=this.jacobianElementA,t=this.jacobianElementB,o=this.bi,i=this.bj,n=o.vlambda,r=i.vlambda,s=o.wlambda||a,l=i.wlambda||a;return e.multiplyVectors(n,s)+t.multiplyVectors(r,l)};var r=new n,s=new n,l=new n,p=new n;o.prototype.computeGiMf=function(){var e=this.jacobianElementA,t=this.jacobianElementB,o=this.bi,i=this.bj,n=o.force,a=o.torque,d=i.force,c=i.torque,u=o.invMassSolve,y=i.invMassSolve;return o.invInertiaWorldSolve?o.invInertiaWorldSolve.vmult(a,l):l.set(0,0,0),i.invInertiaWorldSolve?i.invInertiaWorldSolve.vmult(c,p):p.set(0,0,0),n.mult(u,r),d.mult(y,s),e.multiplyVectors(r,l)+t.multiplyVectors(s,p)};var d=new n;o.prototype.computeGiMGt=function(){var e=this.jacobianElementA,t=this.jacobianElementB,o=this.bi,i=this.bj,n=o.invMassSolve,a=i.invMassSolve,r=o.invInertiaWorldSolve,s=i.invInertiaWorldSolve,l=n+a;return r&&(r.vmult(e.rotational,d),l+=d.dot(e.rotational)),s&&(s.vmult(t.rotational,d),l+=d.dot(t.rotational)),l};var c=new n,u=new n,y=new n,h=new n,m=new n,x=new n;o.prototype.addToWlambda=function(e){var t=this.jacobianElementA,o=this.jacobianElementB,i=this.bi,n=this.bj,a=c;t.spatial.mult(i.invMassSolve*e,a),i.vlambda.vadd(a,i.vlambda),o.spatial.mult(n.invMassSolve*e,a),n.vlambda.vadd(a,n.vlambda),i.invInertiaWorldSolve&&(i.invInertiaWorldSolve.vmult(t.rotational,a),a.mult(e,a),i.wlambda.vadd(a,i.wlambda)),n.invInertiaWorldSolve&&(n.invInertiaWorldSolve.vmult(o.rotational,a),a.mult(e,a),n.wlambda.vadd(a,n.wlambda))},o.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":26,"../math/Vec3":30}],21:[function(e,t){function o(e,t,o){i.call(this,e,t,-o,o),this.ri=new n,this.rj=new n,this.t=new n}t.exports=o;var i=e("./Equation"),n=e("../math/Vec3"),a=e("../math/Mat3");o.prototype=new i,o.prototype.constructor=o;var r=new n,s=new n;o.prototype.computeB=function(e){var o=this.a,i=this.b,n=this.bi,a=this.bj,l=this.ri,p=this.rj,d=r,c=s,u=this.t;l.cross(u,d),p.cross(u,c);var t=this.jacobianElementA,y=this.jacobianElementB;u.negate(t.spatial),d.negate(t.rotational),y.spatial.copy(u),y.rotational.copy(c);var h=this.computeGW(),m=this.computeGiMf();return-h*i-e*m}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],22:[function(e,t){function o(e,t,o){o=o||{};var n="undefined"==typeof o.maxForce?1e6:o.maxForce;a.call(this,e,t,-n,n),this.axisA=o.axisA?o.axisA.clone():new i(1,0,0),this.axisB=o.axisB?o.axisB.clone():new i(0,1,0),this.maxAngle=s/2}t.exports=o;var i=e("../math/Vec3"),n=e("../math/Mat3"),a=e("./Equation");o.prototype=new a,o.prototype.constructor=o;var l=new i,p=new i;o.prototype.computeB=function(e){var t=this.a,o=this.b,i=this.axisA,n=this.axisB,a=l,s=p,d=this.jacobianElementA,c=this.jacobianElementB;i.cross(n,a),n.cross(i,s),d.rotational.copy(s),c.rotational.copy(a);var u=r(this.maxAngle)-i.dot(n),y=this.computeGW(),h=this.computeGiMf();return-u*t-y*o-e*h}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],23:[function(e,t){function o(e,t,o){o="undefined"==typeof o?1e6:o,a.call(this,e,t,-o,o),this.axisA=new i,this.axisB=new i,this.targetVelocity=0}t.exports=o;var i=e("../math/Vec3"),n=e("../math/Mat3"),a=e("./Equation");o.prototype=new a,o.prototype.constructor=o,o.prototype.computeB=function(e){var t=this.a,o=this.b,i=this.bi,n=this.bj,a=this.axisA,r=this.axisB,s=this.jacobianElementA,l=this.jacobianElementB;s.rotational.copy(a),r.negate(l.rotational);var p=this.computeGW()-this.targetVelocity,d=this.computeGiMf();return-p*o-e*d}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],24:[function(e,t){function o(e,t,n){n=i.defaults(n,{friction:0.3,restitution:0.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=o.idCounter++,this.materials=[e,t],this.friction=n.friction,this.restitution=n.restitution,this.contactEquationStiffness=n.contactEquationStiffness,this.contactEquationRelaxation=n.contactEquationRelaxation,this.frictionEquationStiffness=n.frictionEquationStiffness,this.frictionEquationRelaxation=n.frictionEquationRelaxation}var i=e("../utils/Utils");t.exports=o,o.idCounter=0},{"../utils/Utils":53}],25:[function(e,t){function o(e){var t="";e=e||{},"string"==typeof e?(t=e,e={}):"object"==typeof e&&(t=""),this.name=t,this.id=o.idCounter++,this.friction="undefined"==typeof e.friction?-1:e.friction,this.restitution="undefined"==typeof e.restitution?-1:e.restitution}t.exports=o,o.idCounter=0},{}],26:[function(e,t){function o(){this.spatial=new i,this.rotational=new i}t.exports=o;var i=e("./Vec3");o.prototype.multiplyElement=function(e){return e.spatial.dot(this.spatial)+e.rotational.dot(this.rotational)},o.prototype.multiplyVectors=function(e,t){return e.dot(this.spatial)+t.dot(this.rotational)}},{"./Vec3":30}],27:[function(e,t){function o(e){this.elements=e?e:[0,0,0,0,0,0,0,0,0]}t.exports=o;var a=e("./Vec3");o.prototype.identity=function(){var t=this.elements;t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1},o.prototype.setZero=function(){var t=this.elements;t[0]=0,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t[8]=0},o.prototype.setTrace=function(t){var o=this.elements;o[0]=t.x,o[4]=t.y,o[8]=t.z},o.prototype.getTrace=function(t){var t=t||new a,o=this.elements;t.x=o[0],t.y=o[4],t.z=o[8]},o.prototype.vmult=function(t,o){o=o||new a;var i=this.elements,e=t.x,n=t.y,r=t.z;return o.x=i[0]*e+i[1]*n+i[2]*r,o.y=i[3]*e+i[4]*n+i[5]*r,o.z=i[6]*e+i[7]*n+i[8]*r,o},o.prototype.smult=function(e){for(var t=0;t<this.elements.length;t++)this.elements[t]*=e},o.prototype.mmult=function(e,t){for(var n=t||new o,a=0;3>a;a++)for(var i=0,r;3>i;i++){r=0;for(var s=0;3>s;s++)r+=e.elements[a+3*s]*this.elements[s+3*i];n.elements[a+3*i]=r}return n},o.prototype.scale=function(n,a){a=a||new o;for(var r=this.elements,e=a.elements,t=0;3!==t;t++)e[3*t+0]=n.x*r[3*t+0],e[3*t+1]=n.y*r[3*t+1],e[3*t+2]=n.z*r[3*t+2];return a},o.prototype.solve=function(e,t){t=t||new a;for(var o=4,r=[],s=0;s<3*o;s++)r.push(0);var s,i;for(s=0;3>s;s++)for(i=0;3>i;i++)r[s+o*i]=this.elements[s+3*i];r[3]=e.x,r[7]=e.y,r[11]=e.z;var l=3,n=l,d=4,c,u;do{if(s=n-l,0===r[s+o*s])for(i=s+1;i<n;i++)if(0!==r[s+o*i]){c=d;do u=d-c,r[u+o*s]+=r[u+o*i];while(--c);break}if(0!==r[s+o*s])for(i=s+1;i<n;i++){var p=r[s+o*i]/r[s+o*s];c=d;do u=d-c,r[u+o*i]=u<=s?0:r[u+o*i]-r[u+o*s]*p;while(--c)}}while(--l);if(t.z=r[2*o+3]/r[2*o+2],t.y=(r[1*o+3]-r[1*o+2]*t.z)/r[1*o+1],t.x=(r[0*o+3]-r[0*o+2]*t.z-r[0*o+1]*t.y)/r[0*o+0],isNaN(t.x)||isNaN(t.y)||isNaN(t.z)||t.x===Infinity||t.y===Infinity||t.z===Infinity)throw"Could not solve equation! Got x=["+t.toString()+"], b=["+e.toString()+"], A=["+this.toString()+"]";return t},o.prototype.e=function(e,t,o){return void 0===o?this.elements[t+3*e]:void(this.elements[t+3*e]=o)},o.prototype.copy=function(e){for(var t=0;t<e.elements.length;t++)this.elements[t]=e.elements[t];return this},o.prototype.toString=function(){for(var e="",t=0;9>t;t++)e+=this.elements[t]+",";return e},o.prototype.reverse=function(e){e=e||new o;for(var t=3,a=6,r=[],s=0;s<t*a;s++)r.push(0);var s,i;for(s=0;3>s;s++)for(i=0;3>i;i++)r[s+a*i]=this.elements[s+3*i];r[3]=1,r[9]=0,r[15]=0,r[4]=0,r[10]=1,r[16]=0,r[5]=0,r[11]=0,r[17]=1;var l=3,n=l,d=a,c,u;do{if(s=n-l,0===r[s+a*s])for(i=s+1;i<n;i++)if(0!==r[s+a*i]){c=d;do u=d-c,r[u+a*s]+=r[u+a*i];while(--c);break}if(0!==r[s+a*s])for(i=s+1;i<n;i++){var p=r[s+a*i]/r[s+a*s];c=d;do u=d-c,r[u+a*i]=u<=s?0:r[u+a*i]-r[u+a*s]*p;while(--c)}}while(--l);s=2;do{i=s-1;do{var p=r[s+a*i]/r[s+a*s];c=a;do u=a-c,r[u+a*i]=r[u+a*i]-r[u+a*s]*p;while(--c)}while(i--)}while(--s);s=2;do{var p=1/r[s+a*s];c=a;do u=a-c,r[u+a*s]=r[u+a*s]*p;while(--c)}while(s--);s=2;do{i=2;do{if(u=r[t+i+a*s],isNaN(u)||u===Infinity)throw"Could not reverse! A=["+this.toString()+"]";e.e(s,i,u)}while(i--)}while(s--);return e},o.prototype.setRotationFromQuaternion=function(t){var o=t.x,i=t.y,n=t.z,a=t.w,r=o+o,s=i+i,l=n+n,p=o*r,d=o*s,c=o*l,u=i*s,y=i*l,h=n*l,m=a*r,x=a*s,g=a*l,v=this.elements;return v[0]=1-(u+h),v[1]=d-g,v[2]=c+x,v[3]=d+g,v[4]=1-(p+h),v[5]=y-m,v[6]=c-x,v[7]=y+m,v[8]=1-(p+u),this},o.prototype.transpose=function(e){e=e||new o;for(var t=e.elements,n=this.elements,a=0;3!==a;a++)for(var i=0;3!==i;i++)t[3*a+i]=n[3*i+a];return e}},{"./Vec3":30}],28:[function(e,t){function o(e,t,o,i){this.x=e===void 0?0:e,this.y=t===void 0?0:t,this.z=o===void 0?0:o,this.w=i===void 0?1:i}t.exports=o;var i=e("./Vec3");o.prototype.set=function(e,t,o,i){this.x=e,this.y=t,this.z=o,this.w=i},o.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},o.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},o.prototype.setFromAxisAngle=function(e,t){var o=n(0.5*t);this.x=e.x*o,this.y=e.y*o,this.z=e.z*o,this.w=r(0.5*t)},o.prototype.toAxisAngle=function(e){e=e||new i,this.normalize();var t=2*Math.acos(this.w),o=d(1-this.w*this.w);return 1e-3>o?(e.x=this.x,e.y=this.y,e.z=this.z):(e.x=this.x/o,e.y=this.y/o,e.z=this.z/o),[e,t]};var a=new i,l=new i;o.prototype.setFromVectors=function(e,t){if(e.isAntiparallelTo(t)){var o=a;e.tangents(o,l),this.setFromAxisAngle(o,Math.PI)}else{var i=e.cross(t);this.x=i.x,this.y=i.y,this.z=i.z,this.w=d(y(e.norm(),2)*y(t.norm(),2))+e.dot(t),this.normalize()}};var p=new i,c=new i,u=new i;o.prototype.mult=function(e,t){t=t||new o;var i=this.w,n=p,a=c,r=u;return n.set(this.x,this.y,this.z),a.set(e.x,e.y,e.z),t.w=i*e.w-n.dot(a),n.cross(a,r),t.x=i*a.x+e.w*n.x+r.x,t.y=i*a.y+e.w*n.y+r.y,t.z=i*a.z+e.w*n.z+r.z,t},o.prototype.inverse=function(e){var t=this.x,i=this.y,n=this.z,a=this.w;e=e||new o,this.conjugate(e);var r=1/(t*t+i*i+n*n+a*a);return e.x*=r,e.y*=r,e.z*=r,e.w*=r,e},o.prototype.conjugate=function(e){return e=e||new o,e.x=-this.x,e.y=-this.y,e.z=-this.z,e.w=this.w,e},o.prototype.normalize=function(){var e=d(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(e=1/e,this.x*=e,this.y*=e,this.z*=e,this.w*=e)},o.prototype.normalizeFast=function(){var e=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;0==e?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=e,this.y*=e,this.z*=e,this.w*=e)},o.prototype.vmult=function(e,t){t=t||new i;var o=e.x,n=e.y,a=e.z,r=this.x,s=this.y,l=this.z,p=this.w,d=p*o+s*a-l*n,c=p*n+l*o-r*a,u=p*a+r*n-s*o,y=-r*o-s*n-l*a;return t.x=d*p+y*-r+c*-l-u*-s,t.y=c*p+y*-s+u*-r-d*-l,t.z=u*p+y*-l+d*-s-c*-r,t},o.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},o.prototype.toEuler=function(e,t){var o=Math.atan2;t=t||"YZX";var i=this.x,n=this.y,a=this.z,r=this.w,l,p,d;switch(t){case"YZX":var c=i*n+a*r;if(0.499<c&&(l=2*o(i,r),p=s/2,d=0),-0.499>c&&(l=-2*o(i,r),p=-s/2,d=0),isNaN(l)){var u=a*a;l=o(2*n*r-2*i*a,1-2*(n*n)-2*u),p=Math.asin(2*c),d=o(2*i*r-2*n*a,1-2*(i*i)-2*u)}break;default:throw new Error("Euler order "+t+" not supported yet.");}e.y=l,e.z=p,e.x=d},o.prototype.setFromEuler=function(e,t,o,i){i=i||"XYZ";var a=r(e/2),s=r(t/2),l=r(o/2),p=n(e/2),d=n(t/2),c=n(o/2);return"XYZ"===i?(this.x=p*s*l+a*d*c,this.y=a*d*l-p*s*c,this.z=a*s*c+p*d*l,this.w=a*s*l-p*d*c):"YXZ"===i?(this.x=p*s*l+a*d*c,this.y=a*d*l-p*s*c,this.z=a*s*c-p*d*l,this.w=a*s*l+p*d*c):"ZXY"===i?(this.x=p*s*l-a*d*c,this.y=a*d*l+p*s*c,this.z=a*s*c+p*d*l,this.w=a*s*l-p*d*c):"ZYX"===i?(this.x=p*s*l-a*d*c,this.y=a*d*l+p*s*c,this.z=a*s*c-p*d*l,this.w=a*s*l+p*d*c):"YZX"===i?(this.x=p*s*l+a*d*c,this.y=a*d*l+p*s*c,this.z=a*s*c-p*d*l,this.w=a*s*l-p*d*c):"XZY"===i&&(this.x=p*s*l-a*d*c,this.y=a*d*l-p*s*c,this.z=a*s*c+p*d*l,this.w=a*s*l+p*d*c),this},o.prototype.clone=function(){return new o(this.x,this.y,this.z,this.w)}},{"./Vec3":30}],29:[function(e,t){function o(e){e=e||{},this.position=new i,e.position&&this.position.copy(e.position),this.quaternion=new n,e.quaternion&&this.quaternion.copy(e.quaternion)}var i=e("./Vec3"),n=e("./Quaternion");t.exports=o;var a=new n;o.pointToLocalFrame=function(e,t,o,n){var n=n||new i;return o.vsub(e,n),t.conjugate(a),a.vmult(n,n),n},o.prototype.pointToLocal=function(e,t){return o.pointToLocalFrame(this.position,this.quaternion,e,t)},o.pointToWorldFrame=function(e,t,o,n){var n=n||new i;return t.vmult(o,n),n.vadd(e,n),n},o.prototype.pointToWorld=function(e,t){return o.pointToWorldFrame(this.position,this.quaternion,e,t)},o.prototype.vectorToWorldFrame=function(e,t){var t=t||new i;return this.quaternion.vmult(e,t),t},o.vectorToWorldFrame=function(e,t,o){return e.vmult(t,o),o},o.vectorToLocalFrame=function(e,t,o,n){var n=n||new i;return t.w*=-1,t.vmult(o,n),t.w*=-1,n}},{"./Quaternion":28,"./Vec3":30}],30:[function(e,t){function o(e,t,o){this.x=e||0,this.y=t||0,this.z=o||0}t.exports=o;var i=e("./Mat3");o.ZERO=new o(0,0,0),o.UNIT_X=new o(1,0,0),o.UNIT_Y=new o(0,1,0),o.UNIT_Z=new o(0,0,1),o.prototype.cross=function(e,t){var i=e.x,n=e.y,a=e.z,r=this.x,s=this.y,l=this.z;return t=t||new o,t.x=s*a-l*n,t.y=l*i-r*a,t.z=r*n-s*i,t},o.prototype.set=function(e,t,o){return this.x=e,this.y=t,this.z=o,this},o.prototype.setZero=function(){this.x=this.y=this.z=0},o.prototype.vadd=function(e,t){return t?void(t.x=e.x+this.x,t.y=e.y+this.y,t.z=e.z+this.z):new o(this.x+e.x,this.y+e.y,this.z+e.z)},o.prototype.vsub=function(e,t){return t?void(t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z):new o(this.x-e.x,this.y-e.y,this.z-e.z)},o.prototype.crossmat=function(){return new i([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},o.prototype.normalize=function(){var e=this.x,t=this.y,o=this.z,i=d(e*e+t*t+o*o);if(0<i){var n=1/i;this.x*=n,this.y*=n,this.z*=n}else this.x=0,this.y=0,this.z=0;return i},o.prototype.unit=function(e){e=e||new o;var t=this.x,i=this.y,n=this.z,a=d(t*t+i*i+n*n);return 0<a?(a=1/a,e.x=t*a,e.y=i*a,e.z=n*a):(e.x=1,e.y=0,e.z=0),e},o.prototype.norm=function(){var e=this.x,t=this.y,o=this.z;return d(e*e+t*t+o*o)},o.prototype.length=o.prototype.norm,o.prototype.norm2=function(){return this.dot(this)},o.prototype.lengthSquared=o.prototype.norm2,o.prototype.distanceTo=function(e){var t=this.x,o=this.y,i=this.z,n=e.x,a=e.y,r=e.z;return d((n-t)*(n-t)+(a-o)*(a-o)+(r-i)*(r-i))},o.prototype.distanceSquared=function(e){var t=this.x,o=this.y,i=this.z,n=e.x,a=e.y,r=e.z;return(n-t)*(n-t)+(a-o)*(a-o)+(r-i)*(r-i)},o.prototype.mult=function(e,t){t=t||new o;var i=this.x,n=this.y,a=this.z;return t.x=e*i,t.y=e*n,t.z=e*a,t},o.prototype.scale=o.prototype.mult,o.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},o.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},o.prototype.negate=function(e){return e=e||new o,e.x=-this.x,e.y=-this.y,e.z=-this.z,e};var a=new o,r=new o;o.prototype.tangents=function(e,t){var o=this.norm();if(0<o){var i=a,n=1/o;i.set(this.x*n,this.y*n,this.z*n);var s=r;0.9>p(i.x)?(s.set(1,0,0),i.cross(s,e)):(s.set(0,1,0),i.cross(s,e)),i.cross(e,t)}else e.set(1,0,0),t.set(0,1,0)},o.prototype.toString=function(){return this.x+","+this.y+","+this.z},o.prototype.toArray=function(){return[this.x,this.y,this.z]},o.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},o.prototype.lerp=function(e,o,t){var i=this.x,n=this.y,a=this.z;t.x=i+(e.x-i)*o,t.y=n+(e.y-n)*o,t.z=a+(e.z-a)*o},o.prototype.almostEquals=function(e,t){return void 0===t&&(t=1e-6),p(this.x-e.x)>t||p(this.y-e.y)>t||p(this.z-e.z)>t?!1:!0},o.prototype.almostZero=function(e){return void 0===e&&(e=1e-6),p(this.x)>e||p(this.y)>e||p(this.z)>e?!1:!0};var n=new o;o.prototype.isAntiparallelTo=function(e,t){return this.negate(n),n.almostEquals(e,t)},o.prototype.clone=function(){return new o(this.x,this.y,this.z)}},{"./Mat3":27}],31:[function(e,t){function o(e){e=e||{},i.apply(this),this.id=o.idCounter++,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new a,this.collisionFilterGroup="number"==typeof e.collisionFilterGroup?e.collisionFilterGroup:1,this.collisionFilterMask="number"==typeof e.collisionFilterMask?e.collisionFilterMask:1,this.collisionResponse=!0,this.position=new a,e.position&&this.position.copy(e.position),this.previousPosition=new a,this.initPosition=new a,this.velocity=new a,e.velocity&&this.velocity.copy(e.velocity),this.initVelocity=new a,this.force=new a;var t="number"==typeof e.mass?e.mass:0;this.mass=t,this.invMass=0<t?1/t:0,this.material=e.material||null,this.linearDamping="number"==typeof e.linearDamping?e.linearDamping:0.01,this.type=0>=t?o.STATIC:o.DYNAMIC,typeof e.type==typeof o.STATIC&&(this.type=e.type),this.allowSleep=!("undefined"!=typeof e.allowSleep)||e.allowSleep,this.sleepState=0,this.sleepSpeedLimit="undefined"==typeof e.sleepSpeedLimit?0.1:e.sleepSpeedLimit,this.sleepTimeLimit="undefined"==typeof e.sleepTimeLimit?1:e.sleepTimeLimit,this.timeLastSleepy=0,this._wakeUpAfterNarrowphase=!1,this.torque=new a,this.quaternion=new s,e.quaternion&&this.quaternion.copy(e.quaternion),this.initQuaternion=new s,this.angularVelocity=new a,e.angularVelocity&&this.angularVelocity.copy(e.angularVelocity),this.initAngularVelocity=new a,this.interpolatedPosition=new a,this.interpolatedQuaternion=new s,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new a,this.invInertia=new a,this.invInertiaWorld=new r,this.invMassSolve=0,this.invInertiaSolve=new a,this.invInertiaWorldSolve=new r,this.fixedRotation="undefined"!=typeof e.fixedRotation&&e.fixedRotation,this.angularDamping="undefined"==typeof e.angularDamping?0.01:e.angularDamping,this.aabb=new p,this.aabbNeedsUpdate=!0,this.wlambda=new a,e.shape&&this.addShape(e.shape),this.updateMassProperties()}t.exports=o;var i=e("../utils/EventTarget"),n=e("../shapes/Shape"),a=e("../math/Vec3"),r=e("../math/Mat3"),s=e("../math/Quaternion"),l=e("../material/Material"),p=e("../collision/AABB"),d=e("../shapes/Box");o.prototype=new i,o.prototype.constructor=o,o.DYNAMIC=1,o.STATIC=2,o.KINEMATIC=4,o.AWAKE=0,o.SLEEPY=1,o.SLEEPING=2,o.idCounter=0,o.prototype.wakeUp=function(){var e=this.sleepState;this.sleepState=0,e===o.SLEEPING&&this.dispatchEvent({type:"wakeup"})},o.prototype.sleep=function(){this.sleepState=o.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0)},o.sleepyEvent={type:"sleepy"},o.sleepEvent={type:"sleep"},o.prototype.sleepTick=function(e){if(this.allowSleep){var t=this.sleepState,i=this.velocity.norm2()+this.angularVelocity.norm2(),n=y(this.sleepSpeedLimit,2);t===o.AWAKE&&i<n?(this.sleepState=o.SLEEPY,this.timeLastSleepy=e,this.dispatchEvent(o.sleepyEvent)):t===o.SLEEPY&&i>n?this.wakeUp():t===o.SLEEPY&&e-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(o.sleepEvent))}},o.prototype.updateSolveMassProperties=function(){this.sleepState===o.SLEEPING||this.type===o.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},o.prototype.pointToLocalFrame=function(e,t){var t=t||new a;return e.vsub(this.position,t),this.quaternion.conjugate().vmult(t,t),t},o.prototype.vectorToLocalFrame=function(e,t){var t=t||new a;return this.quaternion.conjugate().vmult(e,t),t},o.prototype.pointToWorldFrame=function(e,t){var t=t||new a;return this.quaternion.vmult(e,t),t.vadd(this.position,t),t},o.prototype.vectorToWorldFrame=function(e,t){var t=t||new a;return this.quaternion.vmult(e,t),t};var c=new a,u=new s;o.prototype.addShape=function(e,t,o){var i=new a,n=new s;return t&&i.copy(t),o&&n.copy(o),this.shapes.push(e),this.shapeOffsets.push(i),this.shapeOrientations.push(n),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,this},o.prototype.updateBoundingRadius=function(){for(var e=this.shapes,t=this.shapeOffsets,o=e.length,n=0,a=0,i;a!==o;a++){i=e[a],i.updateBoundingSphereRadius();var s=t[a].norm(),l=i.boundingSphereRadius;s+l>n&&(n=s+l)}this.boundingRadius=n};var h=new p;o.prototype.computeAABB=function(){for(var e=this.shapes,t=this.shapeOffsets,o=this.shapeOrientations,n=e.length,a=c,r=u,s=this.quaternion,l=this.aabb,p=h,d=0,i;d!==n;d++)i=e[d],o[d].mult(s,r),r.vmult(t[d],a),a.vadd(this.position,a),i.calculateWorldAABB(a,r,p.lowerBound,p.upperBound),0===d?l.copy(p):l.extend(p);this.aabbNeedsUpdate=!1};var m=new r,x=new r,g=new r;o.prototype.updateInertiaWorld=function(e){var t=this.invInertia;if(t.x===t.y&&t.y===t.z&&!e);else{var o=m,i=x;o.setRotationFromQuaternion(this.quaternion),o.transpose(i),o.scale(t,o),o.mmult(i,this.invInertiaWorld)}};var v=new a,b=new a;o.prototype.applyForce=function(e,t){if(this.type===o.DYNAMIC){var i=v;t.vsub(this.position,i);var n=b;i.cross(e,n),this.force.vadd(e,this.force),this.torque.vadd(n,this.torque)}};var f=new a,B=new a;o.prototype.applyLocalForce=function(e,t){if(this.type===o.DYNAMIC){var i=f,n=B;this.vectorToWorldFrame(e,i),this.pointToWorldFrame(t,n),this.applyForce(i,n)}};var S=new a,E=new a,A=new a;o.prototype.applyImpulse=function(e,t){if(this.type===o.DYNAMIC){var i=S;t.vsub(this.position,i);var n=E;n.copy(e),n.mult(this.invMass,n),this.velocity.vadd(n,this.velocity);var a=A;i.cross(e,a),this.invInertiaWorld.vmult(a,a),this.angularVelocity.vadd(a,this.angularVelocity)}};var C=new a,z=new a;o.prototype.applyLocalImpulse=function(e,t){if(this.type===o.DYNAMIC){var i=C,n=z;this.vectorToWorldFrame(e,i),this.pointToWorldFrame(t,n),this.applyImpulse(i,n)}};var w=new a;o.prototype.updateMassProperties=function(){var e=w;this.invMass=0<this.mass?1/this.mass:0;var t=this.inertia,o=this.fixedRotation;this.computeAABB(),e.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),d.calculateInertia(e,this.mass,t),this.invInertia.set(0<t.x&&!o?1/t.x:0,0<t.y&&!o?1/t.y:0,0<t.z&&!o?1/t.z:0),this.updateInertiaWorld(!0)},o.prototype.getVelocityAtWorldPoint=function(e,t){var o=new a;return e.vsub(this.position,o),this.angularVelocity.cross(o,t),this.velocity.vadd(t,t),t}},{"../collision/AABB":3,"../material/Material":25,"../math/Mat3":27,"../math/Quaternion":28,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Shape":43,"../utils/EventTarget":49}],32:[function(e,t){function o(e){this.chassisBody=e.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis="undefined"==typeof e.indexRightAxis?1:e.indexRightAxis,this.indexForwardAxis="undefined"==typeof e.indexForwardAxis?0:e.indexForwardAxis,this.indexUpAxis="undefined"==typeof e.indexUpAxis?2:e.indexUpAxis}function n(e,t,o,n,a){var r=0,s=o,l=w,p=R,d=q;e.getVelocityAtWorldPoint(s,l),t.getVelocityAtWorldPoint(s,p),l.vsub(p,d);var c=n.dot(d),u=i(e,o,n),y=i(t,o,n);return r=-c*(1/(u+y)),a<r&&(r=a),r<-a&&(r=-a),r}function i(e,t,o){var i=F,n=P,a=T,r=V;return t.vsub(e.position,i),i.cross(o,n),e.invInertiaWorld.vmult(n,r),r.cross(i,a),e.invMass+o.dot(a)}function a(e,t,o,i,n,a){var r=n.norm2();if(1.1<r)return 0;var s=j,l=I,p=L;e.getVelocityAtWorldPoint(t,s),o.getVelocityAtWorldPoint(i,l),s.vsub(l,p);var d=n.dot(p),c=1/(e.invMass+o.invMass);return-0.2*d*c}var r=e("./Body"),s=e("../math/Vec3"),l=e("../math/Quaternion"),c=e("../collision/RaycastResult"),u=e("../collision/Ray"),y=e("../objects/WheelInfo");t.exports=o;var h=new s,m=new s,x=new s,g=new s,v=new s,b=new s,f=new u;o.prototype.addWheel=function(e){e=e||{};var t=new y(e),o=this.wheelInfos.length;return this.wheelInfos.push(t),o},o.prototype.setSteeringValue=function(e,t){var o=this.wheelInfos[t];o.steering=e};new s;o.prototype.applyEngineForce=function(e,t){this.wheelInfos[t].engineForce=e},o.prototype.setBrake=function(e,t){this.wheelInfos[t].brake=e},o.prototype.addToWorld=function(e){this.constraints;e.add(this.chassisBody);var t=this;this.preStepCallback=function(){t.updateVehicle(e.dt)},e.addEventListener("preStep",this.preStepCallback),this.world=e},o.prototype.getVehicleAxisWorld=function(e,t){t.set(0===e?1:0,1===e?1:0,2===e?1:0),this.chassisBody.vectorToWorldFrame(t,t)},o.prototype.updateVehicle=function(e){for(var t=this.wheelInfos,o=t.length,n=this.chassisBody,a=0;a<o;a++)this.updateWheelTransform(a);this.currentVehicleSpeedKmHour=3.6*n.velocity.norm();var i=new s;this.getVehicleAxisWorld(this.indexForwardAxis,i),0>i.dot(n.velocity)&&(this.currentVehicleSpeedKmHour*=-1);for(var a=0;a<o;a++)this.castRay(t[a]);this.updateSuspension(e);for(var r=new s,l=new s,a=0;a<o;a++){var d=t[a],c=d.suspensionForce;c>d.maxSuspensionForce&&(c=d.maxSuspensionForce),d.raycastResult.hitNormalWorld.scale(c*e,r),d.raycastResult.hitPointWorld.vsub(n.position,l),n.applyImpulse(r,d.raycastResult.hitPointWorld)}this.updateFriction(e);var u=new s,y=new s,h=new s;for(a=0;a<o;a++){var d=t[a];n.getVelocityAtWorldPoint(d.chassisConnectionPointWorld,h);var x=1;switch(this.indexUpAxis){case 1:x=-1;}if(d.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,y);var m=y.dot(d.raycastResult.hitNormalWorld);d.raycastResult.hitNormalWorld.scale(m,u),y.vsub(u,y);var g=y.dot(h);d.deltaRotation=x*g*e/d.radius}(d.sliding||!d.isInContact)&&0!==d.engineForce&&d.useCustomSlidingRotationalSpeed&&(d.deltaRotation=(0<d.engineForce?1:-1)*d.customSlidingRotationalSpeed*e),p(d.brake)>p(d.engineForce)&&(d.deltaRotation=0),d.rotation+=d.deltaRotation,d.deltaRotation*=0.99}},o.prototype.updateSuspension=function(){for(var e=this.chassisBody,t=e.mass,o=this.wheelInfos,i=o.length,n=0,a;n<i;n++)if(a=o[n],a.isInContact){var r=a.suspensionRestLength,s=a.suspensionLength,l;l=a.suspensionStiffness*(r-s)*a.clippedInvContactDotSuspension;var p=a.suspensionRelativeVelocity,d;d=0>p?a.dampingCompression:a.dampingRelaxation,l-=d*p,a.suspensionForce=l*t,0>a.suspensionForce&&(a.suspensionForce=0)}else a.suspensionForce=0},o.prototype.removeFromWorld=function(e){this.constraints;e.remove(this.chassisBody),e.removeEventListener("preStep",this.preStepCallback),this.world=null};var B=new s,S=new s;o.prototype.castRay=function(e){var t=B,o=S;this.updateWheelTransformWorld(e);var i=this.chassisBody,n=-1,a=e.suspensionRestLength+e.radius;e.directionWorld.scale(a,t);var r=e.chassisConnectionPointWorld;r.vadd(t,o);var l=e.raycastResult;l.reset();var p=i.collisionResponse;i.collisionResponse=!1,this.world.rayTest(r,o,l),i.collisionResponse=p;var d=l.body;if(e.raycastResult.groundObject=0,d){n=l.distance,e.raycastResult.hitNormalWorld=l.hitNormalWorld,e.isInContact=!0;var c=l.distance;e.suspensionLength=c-e.radius;var u=e.suspensionRestLength-e.maxSuspensionTravel,y=e.suspensionRestLength+e.maxSuspensionTravel;e.suspensionLength<u&&(e.suspensionLength=u),e.suspensionLength>y&&(e.suspensionLength=y,e.raycastResult.reset());var h=e.raycastResult.hitNormalWorld.dot(e.directionWorld),m=new s;i.getVelocityAtWorldPoint(e.raycastResult.hitPointWorld,m);var x=e.raycastResult.hitNormalWorld.dot(m);if(-0.1<=h)e.suspensionRelativeVelocity=0,e.clippedInvContactDotSuspension=10;else{var g=-1/h;e.suspensionRelativeVelocity=x*g,e.clippedInvContactDotSuspension=g}}else e.suspensionLength=e.suspensionRestLength+0*e.maxSuspensionTravel,e.suspensionRelativeVelocity=0,e.directionWorld.scale(-1,e.raycastResult.hitNormalWorld),e.clippedInvContactDotSuspension=1;return n},o.prototype.updateWheelTransformWorld=function(e){e.isInContact=!1;var t=this.chassisBody;t.pointToWorldFrame(e.chassisConnectionPointLocal,e.chassisConnectionPointWorld),t.vectorToWorldFrame(e.directionLocal,e.directionWorld),t.vectorToWorldFrame(e.axleLocal,e.axleWorld)},o.prototype.updateWheelTransform=function(e){var t=g,o=v,i=b,n=this.wheelInfos[e];this.updateWheelTransformWorld(n),n.directionLocal.scale(-1,t),o.copy(n.axleLocal),t.cross(o,i),i.normalize(),o.normalize();var a=n.steering,r=new l;r.setFromAxisAngle(t,a);var s=new l;s.setFromAxisAngle(o,n.rotation);var d=n.worldTransform.quaternion;this.chassisBody.quaternion.mult(r,d),d.mult(s,d),d.normalize();var c=n.worldTransform.position;c.copy(n.directionWorld),c.scale(n.suspensionLength,c),c.vadd(n.chassisConnectionPointWorld,c)};var E=[new s(1,0,0),new s(0,1,0),new s(0,0,1)];o.prototype.getWheelTransformWorld=function(e){return this.wheelInfos[e].worldTransform};var A=new s,C=[],z=[];o.prototype.updateFriction=function(e){for(var t=A,o=this.wheelInfos,r=o.length,l=this.chassisBody,p=z,c=C,u=0,h=0;h<r;h++){var i=o[h],m=i.raycastResult.body;m&&u++,i.sideImpulse=0,i.forwardImpulse=0,p[h]||(p[h]=new s),c[h]||(c[h]=new s)}for(var h=0;h<r;h++){var i=o[h],m=i.raycastResult.body;if(m){var g=c[h],v=this.getWheelTransformWorld(h);v.vectorToWorldFrame(E[this.indexRightAxis],g);var b=i.raycastResult.hitNormalWorld,f=g.dot(b);b.scale(f,t),g.vsub(t,g),g.normalize(),b.cross(g,p[h]),p[h].normalize(),i.sideImpulse=a(l,i.raycastResult.hitPointWorld,m,i.raycastResult.hitPointWorld,g),i.sideImpulse*=1}}this.sliding=!1;for(var h=0;h<r;h++){var i=o[h],m=i.raycastResult.body,B=0;if(i.slipInfo=1,m){var S=i.brake?i.brake:0;B=n(l,m,i.raycastResult.hitPointWorld,p[h],S),B+=i.engineForce*e;var w=S/B;i.slipInfo*=w}if(i.forwardImpulse=0,i.skidInfo=1,m){i.skidInfo=1;var R=i.suspensionForce*e*i.frictionSlip;i.forwardImpulse=B;var q=i.forwardImpulse*0.5,x=i.sideImpulse*1,y=q*q+x*x;if(i.sliding=!1,y>R*R){this.sliding=!0,i.sliding=!0;var w=R/d(y);i.skidInfo*=w}}}if(this.sliding)for(var h=0,i;h<r;h++)i=o[h],0!==i.sideImpulse&&1>i.skidInfo&&(i.forwardImpulse*=i.skidInfo,i.sideImpulse*=i.skidInfo);for(var h=0;h<r;h++){var i=o[h],F=new s;if(F.copy(i.raycastResult.hitPointWorld),0!==i.forwardImpulse){var P=new s;p[h].scale(i.forwardImpulse,P),l.applyImpulse(P,F)}if(0!==i.sideImpulse){var m=i.raycastResult.body,T=new s;T.copy(i.raycastResult.hitPointWorld);var V=new s;c[h].scale(i.sideImpulse,V),l.pointToLocalFrame(F,F),F["xyz"[this.indexUpAxis]]*=i.rollInfluence,l.pointToWorldFrame(F,F),l.applyImpulse(V,F),V.scale(-1,V),m.applyImpulse(V,T)}}};var w=new s,R=new s,q=new s,F=new s,P=new s,T=new s,V=new s,j=new s,I=new s,L=new s},{"../collision/Ray":9,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Vec3":30,"../objects/WheelInfo":36,"./Body":31}],33:[function(e,t){function o(e){if(this.wheelBodies=[],this.coordinateSystem="undefined"==typeof e.coordinateSystem?new l(1,2,3):e.coordinateSystem.clone(),this.chassisBody=e.chassisBody,!this.chassisBody){var t=new s(new l(5,2,0.5));this.chassisBody=new i(1,t)}this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}var i=e("./Body"),a=e("../shapes/Sphere"),s=e("../shapes/Box"),l=e("../math/Vec3"),p=e("../constraints/HingeConstraint");t.exports=o,o.prototype.addWheel=function(e){e=e||{};var t=e.body;t||(t=new i(1,new a(1.2))),this.wheelBodies.push(t),this.wheelForces.push(0);var o=new l,n="undefined"==typeof e.position?new l:e.position.clone(),r=new l;this.chassisBody.pointToWorldFrame(n,r),t.position.set(r.x,r.y,r.z);var s="undefined"==typeof e.axis?new l(0,1,0):e.axis.clone();this.wheelAxes.push(s);var d=new p(this.chassisBody,t,{pivotA:n,axisA:s,pivotB:l.ZERO,axisB:s,collideConnected:!1});return this.constraints.push(d),this.wheelBodies.length-1},o.prototype.setSteeringValue=function(e,t){var o=this.wheelAxes[t],i=r(e),a=n(e),s=o.x,l=o.y;this.constraints[t].axisA.set(i*s-a*l,a*s+i*l,0)},o.prototype.setMotorSpeed=function(e,t){var o=this.constraints[t];o.enableMotor(),o.motorTargetVelocity=e},o.prototype.disableMotor=function(e){var t=this.constraints[e];t.disableMotor()};var d=new l;o.prototype.setWheelForce=function(e,t){this.wheelForces[t]=e},o.prototype.applyWheelForce=function(e,t){var o=this.wheelAxes[t],i=this.wheelBodies[t],n=i.torque;o.scale(e,d),i.vectorToWorldFrame(d,d),n.vadd(d,n)},o.prototype.addToWorld=function(e){for(var t=this.constraints,o=this.wheelBodies.concat([this.chassisBody]),n=0;n<o.length;n++)e.add(o[n]);for(var n=0;n<t.length;n++)e.addConstraint(t[n]);e.addEventListener("preStep",this._update.bind(this))},o.prototype._update=function(){for(var e=this.wheelForces,t=0;t<e.length;t++)this.applyWheelForce(e[t],t)},o.prototype.removeFromWorld=function(e){for(var t=this.constraints,o=this.wheelBodies.concat([this.chassisBody]),n=0;n<o.length;n++)e.remove(o[n]);for(var n=0;n<t.length;n++)e.removeConstraint(t[n])};var c=new l;o.prototype.getWheelSpeed=function(e){var t=this.wheelAxes[e],o=this.wheelBodies[e],i=o.angularVelocity;return this.chassisBody.vectorToWorldFrame(t,c),i.dot(c)}},{"../constraints/HingeConstraint":15,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Sphere":44,"./Body":31}],34:[function(e,t){function o(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=0.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}t.exports=o;var i=e("../shapes/Shape"),n=e("../math/Vec3"),a=e("../math/Quaternion"),r=e("../shapes/Particle"),l=e("../objects/Body"),p=e("../material/Material");o.prototype.add=function(e){this.particles.push(e),this.neighbors.length<this.particles.length&&this.neighbors.push([])},o.prototype.remove=function(e){var t=this.particles.indexOf(e);-1!==t&&(this.particles.splice(t,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var d=new n;o.prototype.getNeighbors=function(e,t){for(var o=this.particles.length,n=e.id,a=this.smoothingRadius*this.smoothingRadius,r=d,s=0,i;s!==o;s++)i=this.particles[s],i.position.vsub(e.position,r),n!==i.id&&r.norm2()<a&&t.push(i)};var c=new n,h=new n,m=new n,x=new n,g=new n,v=new n;o.prototype.update=function(){for(var e=this.particles.length,t=c,o=this.speedOfSound,n=this.eps,a=0;a!==e;a++){var i=this.particles[a],s=this.neighbors[a];s.length=0,this.getNeighbors(i,s),s.push(this.particles[a]);for(var l=s.length,p=0,d=0;d!==l;d++){i.position.vsub(s[d].position,t);var y=t.norm(),b=this.w(y);p+=s[d].mass*b}this.densities[a]=p,this.pressures[a]=o*o*(this.densities[a]-this.density)}for(var f=h,B=m,S=x,E=g,A=v,a=0,u;a!==e;a++){u=this.particles[a],f.set(0,0,0),B.set(0,0,0);for(var s=this.neighbors[a],l=s.length,d=0,C,z,w;d!==l;d++){w=s[d],u.position.vsub(w.position,E);var R=E.norm();C=-w.mass*(this.pressures[a]/(this.densities[a]*this.densities[a]+n)+this.pressures[d]/(this.densities[d]*this.densities[d]+n)),this.gradw(E,S),S.mult(C,S),f.vadd(S,f),w.velocity.vsub(u.velocity,A),A.mult(1/(1e-4+this.densities[a]*this.densities[d])*this.viscosity*w.mass,A),z=this.nablaw(R),A.mult(z,A),B.vadd(A,B)}B.mult(u.mass,B),f.mult(u.mass,f),u.force.vadd(B,u.force),u.force.vadd(f,u.force)}},o.prototype.w=function(e){var t=this.smoothingRadius;return 315/(64*s*y(t,9))*y(t*t-e*e,3)},o.prototype.gradw=function(e,t){var o=e.norm(),i=this.smoothingRadius;e.mult(945/(32*s*y(i,9))*y(i*i-o*o,2),t)},o.prototype.nablaw=function(e){var t=this.smoothingRadius,o=945/(32*s*y(t,9))*(t*t-e*e)*(7*e*e-3*t*t);return o}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Particle":41,"../shapes/Shape":43}],35:[function(e,t){function o(e,t,o){o=o||{},this.restLength="number"==typeof o.restLength?o.restLength:1,this.stiffness=o.stiffness||100,this.damping=o.damping||1,this.bodyA=e,this.bodyB=t,this.localAnchorA=new i,this.localAnchorB=new i,o.localAnchorA&&this.localAnchorA.copy(o.localAnchorA),o.localAnchorB&&this.localAnchorB.copy(o.localAnchorB),o.worldAnchorA&&this.setWorldAnchorA(o.worldAnchorA),o.worldAnchorB&&this.setWorldAnchorB(o.worldAnchorB)}var i=e("../math/Vec3");t.exports=o,o.prototype.setWorldAnchorA=function(e){this.bodyA.pointToLocalFrame(e,this.localAnchorA)},o.prototype.setWorldAnchorB=function(e){this.bodyB.pointToLocalFrame(e,this.localAnchorB)},o.prototype.getWorldAnchorA=function(e){this.bodyA.pointToWorldFrame(this.localAnchorA,e)},o.prototype.getWorldAnchorB=function(e){this.bodyB.pointToWorldFrame(this.localAnchorB,e)};var n=new i,a=new i,s=new i,p=new i,c=new i,y=new i,h=new i,m=new i,x=new i,g=new i,v=new i;o.prototype.applyForce=function(){var e=this.stiffness,t=this.damping,o=this.restLength,i=this.bodyA,l=this.bodyB,d=n,r=a,b=s,u=p,f=v,B=c,S=y,E=h,A=m,C=x,z=g;this.getWorldAnchorA(B),this.getWorldAnchorB(S),B.vsub(i.position,E),S.vsub(l.position,A),S.vsub(B,d);var w=d.norm();r.copy(d),r.normalize(),l.velocity.vsub(i.velocity,b),l.angularVelocity.cross(A,f),b.vadd(f,b),i.angularVelocity.cross(E,f),b.vsub(f,b),r.mult(-e*(w-o)-t*b.dot(r),u),i.force.vsub(u,i.force),l.force.vadd(u,l.force),E.cross(u,C),A.cross(u,z),i.torque.vsub(C,i.torque),l.torque.vadd(z,l.torque)}},{"../math/Vec3":30}],36:[function(e,t){function i(e){e=s.defaults(e,{chassisConnectionPointLocal:new n,chassisConnectionPointWorld:new n,directionLocal:new n,directionWorld:new n,axleLocal:new n,axleWorld:new n,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:0.01,maxSuspensionForce:o,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-0.1}),this.maxSuspensionTravel=e.maxSuspensionTravel,this.customSlidingRotationalSpeed=e.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=e.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=e.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=e.chassisConnectionPointWorld.clone(),this.directionLocal=e.directionLocal.clone(),this.directionWorld=e.directionWorld.clone(),this.axleLocal=e.axleLocal.clone(),this.axleWorld=e.axleWorld.clone(),this.suspensionRestLength=e.suspensionRestLength,this.suspensionMaxLength=e.suspensionMaxLength,this.radius=e.radius,this.suspensionStiffness=e.suspensionStiffness,this.dampingCompression=e.dampingCompression,this.dampingRelaxation=e.dampingRelaxation,this.frictionSlip=e.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=e.rollInfluence,this.maxSuspensionForce=e.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=e.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new r,this.worldTransform=new a,this.isInContact=!1}var n=e("../math/Vec3"),a=e("../math/Transform"),r=e("../collision/RaycastResult"),s=e("../utils/Utils");t.exports=i;var l=new n,p=new n,l=new n;i.prototype.updateWheel=function(e){var t=this.raycastResult;if(this.isInContact){var o=t.hitNormalWorld.dot(t.directionWorld);t.hitPointWorld.vsub(e.position,p),e.getVelocityAtWorldPoint(p,l);var i=t.hitNormalWorld.dot(l);if(-0.1<=o)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{var n=-1/o;this.suspensionRelativeVelocity=i*n,this.clippedInvContactDotSuspension=n}}else t.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,t.directionWorld.scale(-1,t.hitNormalWorld),this.clippedInvContactDotSuspension=1}},{"../collision/RaycastResult":10,"../math/Transform":29,"../math/Vec3":30,"../utils/Utils":53}],37:[function(e,t){function o(e){i.call(this),this.type=i.types.BOX,this.halfExtents=e,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}t.exports=o;var i=e("./Shape"),n=e("../math/Vec3"),a=e("./ConvexPolyhedron");o.prototype=new i,o.prototype.constructor=o,o.prototype.updateConvexPolyhedronRepresentation=function(){var e=this.halfExtents.x,t=this.halfExtents.y,o=this.halfExtents.z,i=n,r=[new i(-e,-t,-o),new i(e,-t,-o),new i(e,t,-o),new i(-e,t,-o),new i(-e,-t,o),new i(e,-t,o),new i(e,t,o),new i(-e,t,o)],s=[new i(0,0,1),new i(0,1,0),new i(1,0,0)],l=new a(r,[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]]);this.convexPolyhedronRepresentation=l,l.material=this.material},o.prototype.calculateLocalInertia=function(e,t){return t=t||new n,o.calculateInertia(this.halfExtents,e,t),t},o.calculateInertia=function(t,o,i){var n=t;i.x=1/12*o*(2*(2*n.y)*n.y+2*(2*n.z)*n.z),i.y=1/12*o*(2*(2*n.x)*n.x+2*(2*n.z)*n.z),i.z=1/12*o*(2*(2*n.y)*n.y+2*(2*n.x)*n.x)},o.prototype.getSideNormals=function(e,t){var o=e,n=this.halfExtents;if(o[0].set(n.x,0,0),o[1].set(0,n.y,0),o[2].set(0,0,n.z),o[3].set(-n.x,0,0),o[4].set(0,-n.y,0),o[5].set(0,0,-n.z),void 0!==t)for(var a=0;a!==o.length;a++)t.vmult(o[a],o[a]);return o},o.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},o.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var r=new n,s=new n;o.prototype.forEachWorldCorner=function(t,o,n){for(var a=this.halfExtents,e=[[a.x,a.y,a.z],[-a.x,a.y,a.z],[-a.x,-a.y,a.z],[-a.x,-a.y,-a.z],[a.x,-a.y,-a.z],[a.x,a.y,-a.z],[-a.x,a.y,-a.z],[a.x,-a.y,a.z]],s=0;s<e.length;s++)r.set(e[s][0],e[s][1],e[s][2]),o.vmult(r,r),t.vadd(r,r),n(r.x,r.y,r.z)};var l=[new n,new n,new n,new n,new n,new n,new n,new n];o.prototype.calculateWorldAABB=function(t,o,n,a){var r=this.halfExtents;l[0].set(r.x,r.y,r.z),l[1].set(-r.x,r.y,r.z),l[2].set(-r.x,-r.y,r.z),l[3].set(-r.x,-r.y,-r.z),l[4].set(r.x,-r.y,-r.z),l[5].set(r.x,r.y,-r.z),l[6].set(-r.x,r.y,-r.z),l[7].set(r.x,-r.y,r.z);var e=l[0];o.vmult(e,e),t.vadd(e,e),a.copy(e),n.copy(e);for(var s=1,e;8>s;s++){e=l[s],o.vmult(e,e),t.vadd(e,e);var i=e.x,p=e.y,d=e.z;i>a.x&&(a.x=i),p>a.y&&(a.y=p),d>a.z&&(a.z=d),i<n.x&&(n.x=i),p<n.y&&(n.y=p),d<n.z&&(n.z=d)}}},{"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],38:[function(e,t){function n(e,t,o){this;i.call(this),this.type=i.types.CONVEXPOLYHEDRON,this.vertices=e||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=t||[],this.faceNormals=[],this.computeNormals(),this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[],this.uniqueAxes=o?o.slice():null,this.computeEdges(),this.updateBoundingSphereRadius()}t.exports=n;var i=e("./Shape"),a=e("../math/Vec3"),r=e("../math/Quaternion"),l=e("../math/Transform");n.prototype=new i,n.prototype.constructor=n;var c=new a;n.prototype.computeEdges=function(){var e=this.faces,t=this.vertices,o=t.length,n=this.uniqueEdges;n.length=0;for(var a=c,r=0;r!==e.length;r++)for(var i=e[r],s=i.length,l=0,d;l!==s;l++){d=(l+1)%s,t[i[l]].vsub(t[i[d]],a),a.normalize();for(var u=!1,y=0;y!==n.length;y++)if(n[y].almostEquals(a)||n[y].almostEquals(a)){u=!0;break}u||n.push(a.clone())}},n.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var e=0;e<this.faces.length;e++){for(var t=0;t<this.faces[e].length;t++)if(!this.vertices[this.faces[e][t]])throw new Error("Vertex "+this.faces[e][t]+" not found!");var o=this.faceNormals[e]||new a;this.getFaceNormal(e,o),o.negate(o),this.faceNormals[e]=o;var i=this.vertices[this.faces[e][0]];if(0>o.dot(i)){console.error(".faceNormals["+e+"] = Vec3("+o.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule.");for(var t=0;t<this.faces[e].length;t++)console.warn(".vertices["+this.faces[e][t]+"] = Vec3("+this.vertices[this.faces[e][t]].toString()+")")}}};var p=new a,u=new a;n.computeNormal=function(e,t,o,i){t.vsub(e,u),o.vsub(t,p),p.cross(u,i),i.isZero()||i.normalize()},n.prototype.getFaceNormal=function(e,t){var o=this.faces[e],i=this.vertices[o[0]],a=this.vertices[o[1]],r=this.vertices[o[2]];return n.computeNormal(i,a,r,t)};var y=new a;n.prototype.clipAgainstHull=function(e,t,i,n,r,s,l,p,c){for(var u=y,h=this,m=-1,x=-o,g=0;g<i.faces.length;g++){u.copy(i.faceNormals[g]),r.vmult(u,u);var v=u.dot(s);v>x&&(x=v,m=g)}for(var d=[],f=i.faces[m],B=f.length,S=0;S<B;S++){var E=i.vertices[f[S]],b=new a;b.copy(E),r.vmult(b,b),n.vadd(b,b),d.push(b)}0<=m&&this.clipFaceAgainstHull(s,e,t,d,l,p,c)};var h=new a,m=new a,x=new a,g=new a,v=new a,b=new a;n.prototype.findSeparatingAxis=function(e,t,n,a,r,s,l,p){var c=h,u=m,y=x,f=g,B=v,S=b,E=o,A=this,C=0;if(!A.uniqueAxes)for(var z=l?l.length:A.faces.length,w=0,i;w<z;w++){i=l?l[w]:w,c.copy(A.faceNormals[i]),n.vmult(c,c);var R=A.testSepAxis(c,e,t,n,a,r);if(!1===R)return!1;R<E&&(E=R,s.copy(c))}else for(var w=0;w!==A.uniqueAxes.length;w++){n.vmult(A.uniqueAxes[w],c);var R=A.testSepAxis(c,e,t,n,a,r);if(!1===R)return!1;R<E&&(E=R,s.copy(c))}if(!e.uniqueAxes)for(var d=p?p.length:e.faces.length,w=0,i;w<d;w++){i=p?p[w]:w,u.copy(e.faceNormals[i]),r.vmult(u,u),C++;var R=A.testSepAxis(u,e,t,n,a,r);if(!1===R)return!1;R<E&&(E=R,s.copy(u))}else for(var w=0;w!==e.uniqueAxes.length;w++){r.vmult(e.uniqueAxes[w],u),C++;var R=A.testSepAxis(u,e,t,n,a,r);if(!1===R)return!1;R<E&&(E=R,s.copy(u))}for(var q=0;q!==A.uniqueEdges.length;q++){n.vmult(A.uniqueEdges[q],f);for(var F=0;F!==e.uniqueEdges.length;F++)if(r.vmult(e.uniqueEdges[F],B),f.cross(B,S),!S.almostZero()){S.normalize();var P=A.testSepAxis(S,e,t,n,a,r);if(!1===P)return!1;P<E&&(E=P,s.copy(S))}}return a.vsub(t,y),0<y.dot(s)&&s.negate(s),!0};var f=[],B=[];n.prototype.testSepAxis=function(e,t,o,i,a,r){var s=this;n.project(s,e,o,i,f),n.project(t,e,a,r,B);var l=f[0],p=f[1],d=B[0],c=B[1];if(l<c||d<p)return!1;var u=l-c,y=d-p,h=u<y?u:y;return h};var S=new a,E=new a;n.prototype.calculateLocalInertia=function(e,t){this.computeLocalAABB(S,E);var o=E.x-S.x,i=E.y-S.y,n=E.z-S.z;t.x=1/12*e*(2*(2*i)*i+2*(2*n)*n),t.y=1/12*e*(2*(2*o)*o+2*(2*n)*n),t.z=1/12*e*(2*(2*i)*i+2*(2*o)*o)},n.prototype.getPlaneConstantOfFace=function(e){var t=this.faces[e],o=this.faceNormals[e],i=this.vertices[t[0]],n=-o.dot(i);return n};var A=new a,C=new a,z=new a,w=new a,R=new a,q=new a,F=new a,P=new a;n.prototype.clipFaceAgainstHull=function(e,t,n,r,s,l,c){for(var u=A,y=C,h=z,m=w,x=R,g=q,v=F,f=P,B=this,S=[],E=r,T=S,V=-1,I=o,L=0;L<B.faces.length;L++){u.copy(B.faceNormals[L]),n.vmult(u,u);var W=u.dot(e);W<I&&(I=W,V=L)}if(!(0>V)){var d=B.faces[V];d.connectedFaces=[];for(var N=0;N<B.faces.length;N++)for(var i=0;i<B.faces[N].length;i++)-1!==d.indexOf(B.faces[N][i])&&N!==V&&-1===d.connectedFaces.indexOf(N)&&d.connectedFaces.push(N);for(var j=E.length,M=d.length,k=0;k<M;k++){var O=B.vertices[d[k]],a=B.vertices[d[(k+1)%M]];O.vsub(a,y),h.copy(y),n.vmult(h,h),t.vadd(h,h),m.copy(this.faceNormals[V]),n.vmult(m,m),t.vadd(m,m),h.cross(m,x),x.negate(x),g.copy(O),n.vmult(g,g),t.vadd(g,g);var b=-g.dot(x),_;{var D=d.connectedFaces[k];v.copy(this.faceNormals[D]);var H=this.getPlaneConstantOfFace(D);f.copy(v),n.vmult(f,f);var _=H-f.dot(t)}for(this.clipFaceAgainstPlane(E,T,f,_);E.length;)E.shift();for(;T.length;)E.push(T.shift())}v.copy(this.faceNormals[V]);var H=this.getPlaneConstantOfFace(V);f.copy(v),n.vmult(f,f);for(var _=H-f.dot(t),N=0,U;N<E.length;N++)if(U=f.dot(E[N])+_,U<=s&&(console.log("clamped: depth="+U+" to minDist="+(s+"")),U=s),U<=l){var G=E[N];if(0>=U){var Y={point:G,normal:f,depth:U};c.push(Y)}}}},n.prototype.clipFaceAgainstPlane=function(e,t,o,i){var n=e.length,r,s;if(2>n)return t;var l=e[e.length-1],p=e[0];r=o.dot(l)+i;for(var d=0;d<n;d++){if(p=e[d],s=o.dot(p)+i,0>r){if(0>s){var c=new a;c.copy(p),t.push(c)}else{var c=new a;l.lerp(p,r/(r-s),c),t.push(c)}}else if(0>s){var c=new a;l.lerp(p,r/(r-s),c),t.push(c),t.push(p)}l=p,r=s}return t},n.prototype.computeWorldVertices=function(e,t){for(var o=this.vertices.length;this.worldVertices.length<o;)this.worldVertices.push(new a);for(var n=this.vertices,r=this.worldVertices,s=0;s!==o;s++)t.vmult(n[s],r[s]),e.vadd(r[s],r[s]);this.worldVerticesNeedsUpdate=!1};var T=new a;n.prototype.computeLocalAABB=function(e,t){var a=this.vertices.length,n=this.vertices;e.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),t.set(-o,-o,-o);for(var r=0,i;r<a;r++)i=n[r],i.x<e.x?e.x=i.x:i.x>t.x&&(t.x=i.x),i.y<e.y?e.y=i.y:i.y>t.y&&(t.y=i.y),i.z<e.z?e.z=i.z:i.z>t.z&&(t.z=i.z)},n.prototype.computeWorldFaceNormals=function(e){for(var t=this.faceNormals.length;this.worldFaceNormals.length<t;)this.worldFaceNormals.push(new a);for(var o=this.faceNormals,n=this.worldFaceNormals,r=0;r!==t;r++)e.vmult(o[r],n[r]);this.worldFaceNormalsNeedsUpdate=!1},n.prototype.updateBoundingSphereRadius=function(){for(var e=0,t=this.vertices,o=0,i=t.length,n;o!==i;o++)n=t[o].norm2(),n>e&&(e=n);this.boundingSphereRadius=d(e)};var V=new a;n.prototype.calculateWorldAABB=function(e,t,o,a){for(var r=this.vertices.length,n=this.vertices,s=0,i,l,p,d,c,u;s<r;s++){V.copy(n[s]),t.vmult(V,V),e.vadd(V,V);var y=V;y.x<i||i==void 0?i=y.x:(y.x>d||d==void 0)&&(d=y.x),y.y<l||l==void 0?l=y.y:(y.y>c||c==void 0)&&(c=y.y),y.z<p||p==void 0?p=y.z:(y.z>u||u==void 0)&&(u=y.z)}o.set(i,l,p),a.set(d,c,u)},n.prototype.volume=function(){return 4*s*this.boundingSphereRadius/3},n.prototype.getAveragePointLocal=function(e){e=e||new a;for(var t=this.vertices.length,o=this.vertices,n=0;n<t;n++)e.vadd(o[n],e);return e.mult(1/t,e),e},n.prototype.transformAllPoints=function(e,t){var o=this.vertices.length,n=this.vertices;if(t){for(var a=0,i;a<o;a++)i=n[a],t.vmult(i,i);for(var a=0,i;a<this.faceNormals.length;a++)i=this.faceNormals[a],t.vmult(i,i)}if(e)for(var a=0,i;a<o;a++)i=n[a],i.vadd(e,i)};var j=new a,I=new a,L=new a;n.prototype.pointIsInside=function(e){var t=this.vertices.length,o=this.vertices,n=this.faces,a=this.faceNormals,r=this.faces.length,s=j;this.getAveragePointLocal(s);for(var l=0;l<r;l++){var i=this.faces[l].length,t=a[l],p=o[n[l][0]],d=I;e.vsub(p,d);var c=t.dot(d),u=L;s.vsub(p,u);var y=t.dot(u);if(0>c&&0<y||0<c&&0>y)return!1}return-1};var W=new a,N=new a,M=new a;n.project=function(e,t,o,a,r){var s=e.vertices.length,n=N,p=0,d=0,c=M,u=e.vertices;c.setZero(),l.vectorToLocalFrame(o,a,t,n),l.pointToLocalFrame(o,a,c,c);var y=c.dot(n);d=p=u[0].dot(n);for(var h=1,i;h<s;h++)i=u[h].dot(n),i>p&&(p=i),i<d&&(d=i);if(d-=y,p-=y,d>p){var m=d;d=p,p=m}r[0]=p,r[1]=d}},{"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"./Shape":43}],39:[function(e,t){function o(e,t,o,d){var c=d,u=[],y=[],h=[],m=[],x=[],g=r,v=n;u.push(new l(t*g(0),t*v(0),0.5*-o)),m.push(0),u.push(new l(e*g(0),e*v(0),0.5*o)),x.push(1);for(var b=0;b<c;b++){var i=2*s/c*(b+1),f=2*s/c*(b+0.5);b<c-1?(u.push(new l(t*g(i),t*v(i),0.5*-o)),m.push(2*b+2),u.push(new l(e*g(i),e*v(i),0.5*o)),x.push(2*b+3),h.push([2*b+2,2*b+3,2*b+1,2*b])):h.push([0,1,2*b+1,2*b]),(1==c%2||b<c/2)&&y.push(new l(g(f),v(f),0))}h.push(x),y.push(new l(0,0,1));for(var B=[],b=0;b<m.length;b++)B.push(m[m.length-b-1]);h.push(B),this.type=a.types.CONVEXPOLYHEDRON,p.call(this,u,h,y)}t.exports=o;var a=e("./Shape"),l=e("../math/Vec3"),i=e("../math/Quaternion"),p=e("./ConvexPolyhedron");o.prototype=new p},{"../math/Quaternion":28,"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],40:[function(e,i){function n(e,t){t=c.defaults(t,{maxValue:null,minValue:null,elementSize:1}),this.data=e,this.maxValue=t.maxValue,this.minValue=t.minValue,this.elementSize=t.elementSize,null===t.minValue&&this.updateMinValue(),null===t.maxValue&&this.updateMaxValue(),this.cacheEnabled=!0,r.call(this),this.pillarConvex=new s,this.pillarOffset=new d,this.type=r.types.HEIGHTFIELD,this.updateBoundingSphereRadius(),this._cachedPillars={}}var r=e("./Shape"),s=e("./ConvexPolyhedron"),d=e("../math/Vec3"),c=e("../utils/Utils");i.exports=n,n.prototype=new r,n.prototype.update=function(){this._cachedPillars={}},n.prototype.updateMinValue=function(){for(var e=this.data,t=e[0][0],o=0;o!==e.length;o++)for(var i=0,n;i!==e[o].length;i++)n=e[o][i],n<t&&(t=n);this.minValue=t},n.prototype.updateMaxValue=function(){for(var e=this.data,t=e[0][0],o=0;o!==e.length;o++)for(var i=0,n;i!==e[o].length;i++)n=e[o][i],n>t&&(t=n);this.maxValue=t},n.prototype.setHeightValueAtIndex=function(e,t,o){var i=this.data;i[e][t]=o,this.clearCachedConvexTrianglePillar(e,t,!1),0<e&&(this.clearCachedConvexTrianglePillar(e-1,t,!0),this.clearCachedConvexTrianglePillar(e-1,t,!1)),0<t&&(this.clearCachedConvexTrianglePillar(e,t-1,!0),this.clearCachedConvexTrianglePillar(e,t-1,!1)),0<t&&0<e&&this.clearCachedConvexTrianglePillar(e-1,t-1,!0)},n.prototype.getRectMinMax=function(e,t,o,n,a){a=a||[];for(var r=this.data,s=this.minValue,l=e;l<=o;l++)for(var i=t,p;i<=n;i++)p=r[l][i],p>s&&(s=p);a[0]=this.minValue,a[1]=s},n.prototype.getIndexOfPosition=function(e,o,i,n){var a=this.elementSize,r=this.data,s=t(e/a),l=t(o/a);return i[0]=s,i[1]=l,n&&(0>s&&(s=0),0>l&&(l=0),s>=r.length-1&&(s=r.length-1),l>=r[0].length-1&&(l=r[0].length-1)),0>s||0>l||s>=r.length-1||l>=r[0].length-1?!1:!0},n.prototype.getHeightAt=function(e,t,o){var i=[];this.getIndexOfPosition(e,t,i,o);var n=[];return this.getRectMinMax(i[0],i[1]+1,i[0],i[1]+1,n),(n[0]+n[1])/2},n.prototype.getCacheConvexTrianglePillarKey=function(e,t,o){return e+"_"+t+"_"+(o?1:0)},n.prototype.getCachedConvexTrianglePillar=function(e,t,o){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,o)]},n.prototype.setCachedConvexTrianglePillar=function(e,t,o,i,n){this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,o)]={convex:i,offset:n}},n.prototype.clearCachedConvexTrianglePillar=function(e,t,o){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,o)]},n.prototype.getConvexTrianglePillar=function(e,t,o){var n=this.pillarConvex,a=this.pillarOffset;if(this.cacheEnabled){var r=this.getCachedConvexTrianglePillar(e,t,o);if(r)return this.pillarConvex=r.convex,void(this.pillarOffset=r.offset);n=new s,a=new d,this.pillarConvex=n,this.pillarOffset=a}var r=this.data,p=this.elementSize,c=n.faces;n.vertices.length=6;for(var u=0;6>u;u++)n.vertices[u]||(n.vertices[u]=new d);c.length=5;for(var u=0;5>u;u++)c[u]||(c[u]=[]);var i=n.vertices,y=(l(r[e][t],r[e+1][t],r[e][t+1],r[e+1][t+1])-this.minValue)/2+this.minValue;o?(a.set((e+0.75)*p,(t+0.75)*p,y),i[0].set(0.25*p,0.25*p,r[e+1][t+1]-y),i[1].set(-0.75*p,0.25*p,r[e][t+1]-y),i[2].set(0.25*p,-0.75*p,r[e+1][t]-y),i[3].set(0.25*p,0.25*p,-y-1),i[4].set(-0.75*p,0.25*p,-y-1),i[5].set(0.25*p,-0.75*p,-y-1),c[0][0]=0,c[0][1]=1,c[0][2]=2,c[1][0]=5,c[1][1]=4,c[1][2]=3,c[2][0]=2,c[2][1]=5,c[2][2]=3,c[2][3]=0,c[3][0]=3,c[3][1]=4,c[3][2]=1,c[3][3]=0,c[4][0]=1,c[4][1]=4,c[4][2]=5,c[4][3]=2):(a.set((e+0.25)*p,(t+0.25)*p,y),i[0].set(-0.25*p,-0.25*p,r[e][t]-y),i[1].set(0.75*p,-0.25*p,r[e+1][t]-y),i[2].set(-0.25*p,0.75*p,r[e][t+1]-y),i[3].set(-0.25*p,-0.25*p,-y-1),i[4].set(0.75*p,-0.25*p,-y-1),i[5].set(-0.25*p,0.75*p,-y-1),c[0][0]=0,c[0][1]=1,c[0][2]=2,c[1][0]=5,c[1][1]=4,c[1][2]=3,c[2][0]=0,c[2][1]=2,c[2][2]=5,c[2][3]=3,c[3][0]=1,c[3][1]=0,c[3][2]=3,c[3][3]=4,c[4][0]=4,c[4][1]=5,c[4][2]=2,c[4][3]=1),n.computeNormals(),n.computeEdges(),n.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(e,t,o,n,a)},n.prototype.calculateLocalInertia=function(e,t){return t=t||new d,t.set(0,0,0),t},n.prototype.volume=function(){return o},n.prototype.calculateWorldAABB=function(e,t,i,n){i.set(-o,-o,-o),n.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},n.prototype.updateBoundingSphereRadius=function(){var e=this.data,t=this.elementSize;this.boundingSphereRadius=new d(e.length*t,e[0].length*t,a(p(this.maxValue),p(this.minValue))).norm()}},{"../math/Vec3":30,"../utils/Utils":53,"./ConvexPolyhedron":38,"./Shape":43}],41:[function(e,t){function o(){i.call(this),this.type=i.types.PARTICLE}t.exports=o;var i=e("./Shape"),n=e("../math/Vec3");o.prototype=new i,o.prototype.constructor=o,o.prototype.calculateLocalInertia=function(e,t){return t=t||new n,t.set(0,0,0),t},o.prototype.volume=function(){return 0},o.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},o.prototype.calculateWorldAABB=function(e,t,o,i){o.copy(e),i.copy(e)}},{"../math/Vec3":30,"./Shape":43}],42:[function(e,t){function i(){n.call(this),this.type=n.types.PLANE,this.worldNormal=new a,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=o}t.exports=i;var n=e("./Shape"),a=e("../math/Vec3");i.prototype=new n,i.prototype.constructor=i,i.prototype.computeWorldNormal=function(e){var t=this.worldNormal;t.set(0,0,1),e.vmult(t,t),this.worldNormalNeedsUpdate=!1},i.prototype.calculateLocalInertia=function(e,t){return t=t||new a,t},i.prototype.volume=function(){return o};var r=new a;i.prototype.calculateWorldAABB=function(e,t,i,n){r.set(0,0,1),t.vmult(r,r);var a=o;i.set(-a,-a,-a),n.set(a,a,a),1===r.x&&(n.x=e.x),1===r.y&&(n.y=e.y),1===r.z&&(n.z=e.z),-1===r.x&&(i.x=e.x),-1===r.y&&(i.y=e.y),-1===r.z&&(i.z=e.z)},i.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=o}},{"../math/Vec3":30,"./Shape":43}],43:[function(e,t){function o(){this.id=o.idCounter++,this.type=0,this.boundingSphereRadius=0,this.collisionResponse=!0,this.material=null}t.exports=o;var o=e("./Shape"),i=e("../math/Vec3"),n=e("../math/Quaternion"),a=e("../material/Material");o.prototype.constructor=o,o.prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},o.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},o.prototype.calculateLocalInertia=function(){throw"calculateLocalInertia() not implemented for shape type "+this.type},o.idCounter=0,o.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"./Shape":43}],44:[function(e,t){function o(e){if(i.call(this),this.radius=void 0===e?1:+e,this.type=i.types.SPHERE,0>this.radius)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}t.exports=o;var i=e("./Shape"),n=e("../math/Vec3");o.prototype=new i,o.prototype.constructor=o,o.prototype.calculateLocalInertia=function(e,t){t=t||new n;var o=2*e*this.radius*this.radius/5;return t.x=o,t.y=o,t.z=o,t},o.prototype.volume=function(){return 4*s*this.radius/3},o.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},o.prototype.calculateWorldAABB=function(e,t,o,n){for(var a=this.radius,r=["x","y","z"],s=0,i;s<r.length;s++)i=r[s],o[i]=e[i]-a,n[i]=e[i]+a}},{"../math/Vec3":30,"./Shape":43}],45:[function(e,t){function o(e,t){i.call(this),this.type=i.types.TRIMESH,this.vertices=new Float32Array(e),this.indices=new Int16Array(t),this.normals=new Float32Array(t.length),this.aabb=new u,this.edges=null,this.scale=new l(1,1,1),this.tree=new c,this.updateEdges(),this.updateNormals(),this.updateAABB(),this.updateBoundingSphereRadius(),this.updateTree()}t.exports=o;var i=e("./Shape"),l=e("../math/Vec3"),a=e("../math/Quaternion"),p=e("../math/Transform"),u=e("../collision/AABB"),c=e("../utils/Octree");o.prototype=new i,o.prototype.constructor=o;var y=new l;o.prototype.updateTree=function(){var e=this.tree;e.reset(),e.aabb.copy(this.aabb);var t=this.scale;e.aabb.lowerBound.x*=1/t.x,e.aabb.lowerBound.y*=1/t.y,e.aabb.lowerBound.z*=1/t.z,e.aabb.upperBound.x*=1/t.x,e.aabb.upperBound.y*=1/t.y,e.aabb.upperBound.z*=1/t.z;for(var o=new u,n=new l,a=new l,r=new l,s=[n,a,r],p=0,i;p<this.indices.length/3;p++)i=3*p,this._getUnscaledVertex(this.indices[i],n),this._getUnscaledVertex(this.indices[i+1],a),this._getUnscaledVertex(this.indices[i+2],r),o.setFromPoints(s),e.insert(o,p);e.removeEmptyNodes()};var h=new u;o.prototype.getTrianglesInAABB=function(e,t){h.copy(e);var o=this.scale,i=o.x,n=o.y,a=o.z,r=h.lowerBound,s=h.upperBound;return r.x/=i,r.y/=n,r.z/=a,s.x/=i,s.y/=n,s.z/=a,this.tree.aabbQuery(h,t)},o.prototype.setScale=function(e){var t=this.scale.x===this.scale.y===this.scale.z,o=e.x===e.y===e.z;t&&o||this.updateNormals(),this.scale.copy(e),this.updateAABB(),this.updateBoundingSphereRadius()},o.prototype.updateNormals=function(){for(var e=y,t=this.normals,n=0;n<this.indices.length/3;n++){var i=3*n,r=this.indices[i],a=this.indices[i+1],s=this.indices[i+2];this.getVertex(r,f),this.getVertex(a,B),this.getVertex(s,S),o.computeNormal(B,f,S,e),t[i]=e.x,t[i+1]=e.y,t[i+2]=e.z}},o.prototype.updateEdges=function(){for(var e={},t=function(){var t=n<a?n+"_"+a:a+"_"+n;e[t]=!0},o=0;o<this.indices.length/3;o++){var i=3*o,n=this.indices[i],a=this.indices[i+1],r=this.indices[i+2];t(n,a),t(a,r),t(r,n)}var s=Object.keys(e);this.edges=new Int16Array(2*s.length);for(var o=0,l;o<s.length;o++)l=s[o].split("_"),this.edges[2*o]=parseInt(l[0],10),this.edges[2*o+1]=parseInt(l[1],10)},o.prototype.getEdgeVertex=function(e,t,o){var i=this.edges[2*e+(t?1:0)];this.getVertex(i,o)};var m=new l,x=new l;o.prototype.getEdgeVector=function(e,t){var o=m,i=x;this.getEdgeVertex(e,0,o),this.getEdgeVertex(e,1,i),i.vsub(o,t)};var g=new l,v=new l;o.computeNormal=function(e,t,o,i){t.vsub(e,v),o.vsub(t,g),g.cross(v,i),i.isZero()||i.normalize()};var f=new l,B=new l,S=new l;o.prototype.getVertex=function(e,t){var o=this.scale;return this._getUnscaledVertex(e,t),t.x*=o.x,t.y*=o.y,t.z*=o.z,t},o.prototype._getUnscaledVertex=function(e,t){var o=3*e,i=this.vertices;return t.set(i[o],i[o+1],i[o+2])},o.prototype.getWorldVertex=function(e,t,o,i){return this.getVertex(e,i),p.pointToWorldFrame(t,o,i,i),i},o.prototype.getTriangleVertices=function(e,t,o,i){var n=3*e;this.getVertex(this.indices[n],t),this.getVertex(this.indices[n+1],o),this.getVertex(this.indices[n+2],i)},o.prototype.getNormal=function(e,t){var o=3*e;return t.set(this.normals[o],this.normals[o+1],this.normals[o+2])};var b=new u;o.prototype.calculateLocalInertia=function(e,t){this.computeLocalAABB(b);var o=b.upperBound.x-b.lowerBound.x,i=b.upperBound.y-b.lowerBound.y,n=b.upperBound.z-b.lowerBound.z;return t.set(1/12*e*(2*(2*i)*i+2*(2*n)*n),1/12*e*(2*(2*o)*o+2*(2*n)*n),1/12*e*(2*(2*i)*i+2*(2*o)*o))};var E=new l;o.prototype.computeLocalAABB=function(e){var t=e.lowerBound,o=e.upperBound,a=this.vertices.length,n=this.vertices,r=E;this.getVertex(0,r),t.copy(r),o.copy(r);for(var s=0;s!==a;s++)this.getVertex(s,r),r.x<t.x?t.x=r.x:r.x>o.x&&(o.x=r.x),r.y<t.y?t.y=r.y:r.y>o.y&&(o.y=r.y),r.z<t.z?t.z=r.z:r.z>o.z&&(o.z=r.z)},o.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)},o.prototype.updateBoundingSphereRadius=function(){for(var e=0,t=this.vertices,o=new l,n=0,i=t.length/3;n!==i;n++){this.getVertex(n,o);var a=o.norm2();a>e&&(e=a)}this.boundingSphereRadius=d(e)};var A=new l,C=new p,z=new u;o.prototype.calculateWorldAABB=function(e,t,o,i){var n=C,a=z;n.position=e,n.quaternion=t,this.aabb.toWorldFrame(n,a),o.copy(a.lowerBound),i.copy(a.upperBound)},o.prototype.volume=function(){return 4*s*this.boundingSphereRadius/3},o.createTorus=function(e,t,l,p,h){e=e||1,t=t||0.5,l=l||8,p=p||6,h=h||2*s;for(var m=[],g=[],f=0;f<=l;f++)for(var B=0;B<=p;B++){var i=B/p*h,u=2*(f/l*s),v=(e+t*r(u))*r(i),x=(e+t*r(u))*n(i),y=t*n(u);m.push(v,x,y)}for(var f=1;f<=l;f++)for(var B=1;B<=p;B++){var S=(p+1)*f+B-1,a=(p+1)*(f-1)+B-1,b=(p+1)*(f-1)+B,c=(p+1)*f+B;g.push(S,a,c),g.push(a,b,c)}return new o(m,g)}},{"../collision/AABB":3,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../utils/Octree":50,"./Shape":43}],46:[function(e,t){function o(){a.call(this),this.iterations=10,this.tolerance=1e-7}t.exports=o;var i=e("../math/Vec3"),n=e("../math/Quaternion"),a=e("./Solver");o.prototype=new a;var r=[],s=[],l=[];o.prototype.solve=function(e,t){var o=0,n=this.iterations,a=this.tolerance*this.tolerance,p=this.equations,d=p.length,u=t.bodies,y=u.length,h,m,x,g,f,B;if(0!==d)for(var S=0;S!==y;S++)u[S].updateSolveMassProperties();var i=s,E=l,A=r;i.length=d,E.length=d,A.length=d;for(var S=0,C;S!==d;S++)C=p[S],A[S]=0,E[S]=C.computeB(e),i[S]=1/C.computeC();if(0!==d){for(var S=0;S!==y;S++){var c=u[S],b=c.vlambda,z=c.wlambda;b.set(0,0,0),z&&z.set(0,0,0)}for(o=0;o!==n;o++){g=0;for(var R=0,C;R!==d;R++)C=p[R],h=E[R],m=i[R],B=A[R],f=C.computeGWlambda(),x=m*(h-f-C.eps*B),B+x<C.minForce?x=C.minForce-B:B+x>C.maxForce&&(x=C.maxForce-B),A[R]+=x,g+=0<x?x:-x,C.addToWlambda(x);if(g*g<a)break}for(var S=0;S!==y;S++){var c=u[S],q=c.velocity,v=c.angularVelocity;q.vadd(c.vlambda,q),v&&v.vadd(c.wlambda,v)}}return o}},{"../math/Quaternion":28,"../math/Vec3":30,"./Solver":47}],47:[function(e,t){function o(){this.equations=[]}t.exports=o,o.prototype.solve=function(){return 0},o.prototype.addEquation=function(e){e.enabled&&this.equations.push(e)},o.prototype.removeEquation=function(e){var t=this.equations,o=t.indexOf(e);-1!==o&&t.splice(o,1)},o.prototype.removeAllEquations=function(){this.equations.length=0}},{}],48:[function(e,t){function o(e){for(p.call(this),this.iterations=10,this.tolerance=1e-7,this.subsolver=e,this.nodes=[],this.nodePool=[];128>this.nodePool.length;)this.nodePool.push(this.createNode())}function a(e){for(var t=e.length,o=0,i;o!==t;o++)if(i=e[o],!i.visited&&!(i.body.type&h))return i;return!1}function r(e,t,o,i){for(m.push(e),e.visited=!0,t(e,o,i);m.length;)for(var n=m.pop(),r;r=a(n.children);)r.visited=!0,t(r,o,i),m.push(r)}function s(e,t,o){t.push(e.body);for(var n=e.eqs.length,a=0,i;a!==n;a++)i=e.eqs[a],-1===o.indexOf(i)&&o.push(i)}function l(e,t){return t.id-e.id}t.exports=o;var i=e("../math/Vec3"),n=e("../math/Quaternion"),p=e("./Solver"),d=e("../objects/Body");o.prototype=new p;var c=[],u=[],y={bodies:[]},h=d.STATIC,m=[];o.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},o.prototype.solve=function(e,t){for(var o=c,p=this.nodePool,d=t.bodies,h=this.equations,m=h.length,x=d.length,g=this.subsolver;p.length<x;)p.push(this.createNode());o.length=x;for(var v=0;v<x;v++)o[v]=p[v];for(var v=0,i;v!==x;v++)i=o[v],i.body=d[v],i.children.length=0,i.eqs.length=0,i.visited=!1;for(var b=0;b!==m;b++){var f=h[b],v=d.indexOf(f.bi),B=d.indexOf(f.bj),S=o[v],E=o[B];S.children.push(E),S.eqs.push(f),E.children.push(S),E.eqs.push(f)}var A=0,n=u,C;g.tolerance=this.tolerance,g.iterations=this.iterations;for(var z=y;C=a(o);){n.length=0,z.bodies.length=0,r(C,s,z.bodies,n);var w=n.length;n=n.sort(l);for(var v=0;v!==w;v++)g.addEquation(n[v]);g.solve(e,z);g.removeAllEquations(),A++}return A}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"./Solver":47}],49:[function(e,t){var o=function(){};t.exports=o,o.prototype={constructor:o,addEventListener:function(e,t){void 0===this._listeners&&(this._listeners={});var o=this._listeners;return void 0===o[e]&&(o[e]=[]),-1===o[e].indexOf(t)&&o[e].push(t),this},hasEventListener:function(e,t){if(this._listeners===void 0)return!1;var o=this._listeners;return void 0!==o[e]&&-1!==o[e].indexOf(t)},removeEventListener:function(e,t){if(void 0===this._listeners)return this;var o=this._listeners;if(void 0===o[e])return this;var i=o[e].indexOf(t);return-1!==i&&o[e].splice(i,1),this},dispatchEvent:function(e){if(this._listeners===void 0)return this;var t=this._listeners,o=t[e.type];if(o!==void 0){e.target=this;for(var n=0,i=o.length;n<i;n++)o[n].call(this,e)}return this}}},{}],50:[function(e,t){function o(e){e=e||{},this.root=e.root||null,this.aabb=e.aabb?e.aabb.clone():new n,this.data=[],this.children=[]}function i(e,t){t=t||{},t.root=null,t.aabb=e,o.call(this,t),this.maxDepth="undefined"==typeof t.maxDepth?8:t.maxDepth}var n=e("../collision/AABB"),a=e("../math/Vec3");t.exports=i,i.prototype=new o,o.prototype.reset=function(){this.children.length=this.data.length=0},o.prototype.insert=function(e,t,o){var n=this.data;if(o=o||0,!this.aabb.contains(e))return!1;var a=this.children;if(o<(this.maxDepth||this.root.maxDepth)){var r=!1;a.length||(this.subdivide(),r=!0);for(var s=0;8!==s;s++)if(a[s].insert(e,t,o+1))return!0;r&&(a.length=0)}return n.push(t),!0};var r=new a;o.prototype.subdivide=function(){var e=this.aabb,t=e.lowerBound,s=e.upperBound,l=this.children;l.push(new o({aabb:new n({lowerBound:new a(0,0,0)})}),new o({aabb:new n({lowerBound:new a(1,0,0)})}),new o({aabb:new n({lowerBound:new a(1,1,0)})}),new o({aabb:new n({lowerBound:new a(1,1,1)})}),new o({aabb:new n({lowerBound:new a(0,1,1)})}),new o({aabb:new n({lowerBound:new a(0,0,1)})}),new o({aabb:new n({lowerBound:new a(1,0,1)})}),new o({aabb:new n({lowerBound:new a(0,1,0)})})),s.vsub(t,r),r.scale(0.5,r);for(var p=this.root||this,d=0,i;8!==d;d++){i=l[d],i.root=p;var c=i.aabb.lowerBound;c.x*=r.x,c.y*=r.y,c.z*=r.z,c.vadd(t,c),c.vadd(r,i.aabb.upperBound)}},o.prototype.aabbQuery=function(e,t){for(var o=this.data,i=this.children,n=[this];n.length;){var a=n.pop();a.aabb.overlaps(e)&&Array.prototype.push.apply(t,a.data),Array.prototype.push.apply(n,a.children)}return t};var s=new n;o.prototype.rayQuery=function(e,t,o){return e.getAABB(s),s.toLocalFrame(t,s),this.aabbQuery(s,o),o},o.prototype.removeEmptyNodes=function(){for(var e=[this];e.length;){for(var t=e.pop(),o=t.children.length-1;0<=o;o--)t.children[o].data.length||t.children.splice(o,1);Array.prototype.push.apply(e,t.children)}}},{"../collision/AABB":3,"../math/Vec3":30}],51:[function(e,t){function o(){this.objects=[],this.type=Object}t.exports=o,o.prototype.release=function(){for(var e=arguments.length,t=0;t!==e;t++)this.objects.push(arguments[t])},o.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},o.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")}},{}],52:[function(e,t){function o(){this.data={keys:[]}}t.exports=o,o.prototype.get=function(e,t){if(e>t){var o=t;t=e,e=o}return this.data[e+"-"+t]},o.prototype.set=function(e,t,o){if(e>t){var i=t;t=e,e=i}var n=e+"-"+t;this.get(e,t)||this.data.keys.push(n),this.data[n]=o},o.prototype.reset=function(){for(var e=this.data,t=e.keys;0<t.length;){var o=t.pop();delete e[o]}}},{}],53:[function(e,t){function o(){}t.exports=o,o.defaults=function(e,t){for(var o in e=e||{},t)o in e||(e[o]=t[o]);return e}},{}],54:[function(e,t){function o(){n.call(this),this.type=i}t.exports=o;var i=e("../math/Vec3"),n=e("./Pool");o.prototype=new n,o.prototype.constructObject=function(){return new i}},{"../math/Vec3":30,"./Pool":51}],55:[function(e,o){function i(e){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new m,this.world=e,this.currentContactMaterial=null,this.enableFrictionReduction=!1}function n(e,t,o){for(var n=null,a=e.length,s=0;s!==a;s++){var i=e[s],l=G;e[(s+1)%a].vsub(i,l);var p=Y;l.cross(t,p);var d=Q;o.vsub(i,d);var c=p.dot(d);if(null==n||0<c&&!0===n||0>=c&&!1===n){null==n&&(n=0<c);continue}else return!1}return!0}o.exports=i;var a=e("../collision/AABB"),r=e("../shapes/Shape"),s=e("../collision/Ray"),l=e("../math/Vec3"),d=e("../math/Transform"),u=e("../shapes/ConvexPolyhedron"),y=e("../math/Quaternion"),h=e("../solver/Solver"),m=e("../utils/Vec3Pool"),x=e("../equations/ContactEquation"),g=e("../equations/FrictionEquation");i.prototype.createContactEquation=function(e,t,o,i,n,a){var r;this.contactPointPool.length?(r=this.contactPointPool.pop(),r.bi=e,r.bj=t):r=new x(e,t),r.enabled=e.collisionResponse&&t.collisionResponse&&o.collisionResponse&&i.collisionResponse;var s=this.currentContactMaterial;r.restitution=s.restitution,r.setSpookParams(s.contactEquationStiffness,s.contactEquationRelaxation,this.world.dt);var l=o.material||e.material,p=i.material||t.material;return l&&p&&0<=l.restitution&&0<=p.restitution&&(r.restitution=l.restitution*p.restitution),r.si=n||o,r.sj=a||i,r},i.prototype.createFrictionEquationsFromContact=function(e,t){var o=e.bi,i=e.bj,n=e.si,a=e.sj,r=this.world,s=this.currentContactMaterial,l=s.friction,p=n.material||o.material,d=a.material||i.material;if(p&&d&&0<=p.friction&&0<=d.friction&&(l=p.friction*d.friction),0<l){var c=l*r.gravity.length(),u=o.invMass+i.invMass;0<u&&(u=1/u);var y=this.frictionEquationPool,h=y.length?y.pop():new g(o,i,c*u),m=y.length?y.pop():new g(o,i,c*u);return h.bi=m.bi=o,h.bj=m.bj=i,h.minForce=m.minForce=-c*u,h.maxForce=m.maxForce=c*u,h.ri.copy(e.ri),h.rj.copy(e.rj),m.ri.copy(e.ri),m.rj.copy(e.rj),e.ni.tangents(h.t,m.t),h.setSpookParams(s.frictionEquationStiffness,s.frictionEquationRelaxation,r.dt),m.setSpookParams(s.frictionEquationStiffness,s.frictionEquationRelaxation,r.dt),h.enabled=m.enabled=e.enabled,t.push(h,m),!0}return!1};var v=new l,b=new l,f=new l;i.prototype.createFrictionFromAverage=function(e){var t=this.result[this.result.length-1];if(this.createFrictionEquationsFromContact(t,this.frictionResult)&&1!==e){var o=this.frictionResult[this.frictionResult.length-2],n=this.frictionResult[this.frictionResult.length-1];v.setZero(),b.setZero(),f.setZero();for(var a=t.bi,r=t.bj,s=0;s!==e;s++)t=this.result[this.result.length-1-s],t.bodyA===a?(v.vsub(t.ni,v),b.vadd(t.rj,b),f.vadd(t.ri,f)):(v.vadd(t.ni,v),b.vadd(t.ri,b),f.vadd(t.rj,f));var i=1/e;b.scale(i,o.ri),f.scale(i,o.rj),n.ri.copy(o.ri),n.rj.copy(o.rj),v.normalize(),v.tangents(o.t,n.t)}};var B=new l,S=new l,E=new y,A=new y;i.prototype.getContacts=function(e,t,o,n,a,r,s){this.contactPointPool=a,this.frictionEquationPool=s,this.result=n,this.frictionResult=r;for(var l=E,p=A,d=B,c=S,u=0,y=e.length;u!==y;u++){var h=e[u],m=t[u],x=null;h.material&&m.material&&(x=o.getContactMaterial(h.material,m.material)||null);for(var g=0;g<h.shapes.length;g++){h.quaternion.mult(h.shapeOrientations[g],l),h.quaternion.vmult(h.shapeOffsets[g],d),d.vadd(h.position,d);for(var i=h.shapes[g],v=0;v<m.shapes.length;v++){m.quaternion.mult(m.shapeOrientations[v],p),m.quaternion.vmult(m.shapeOffsets[v],c),c.vadd(m.position,c);var b=m.shapes[v];if(!(d.distanceTo(c)>i.boundingSphereRadius+b.boundingSphereRadius)){var f=null;i.material&&b.material&&(f=o.getContactMaterial(i.material,b.material)||null),this.currentContactMaterial=f||x||o.defaultContactMaterial;var C=this[i.type|b.type];C&&(i.type<b.type?C.call(this,i,b,d,c,l,p,h,m,i,b):C.call(this,b,i,c,d,p,l,m,h,i,b))}}}}};i.prototype[r.types.BOX|r.types.BOX]=i.prototype.boxBox=function(e,t,o,i,n,a,r,s){e.convexPolyhedronRepresentation.material=e.material,t.convexPolyhedronRepresentation.material=t.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,t.convexPolyhedronRepresentation,o,i,n,a,r,s,e,t)},i.prototype[r.types.BOX|r.types.CONVEXPOLYHEDRON]=i.prototype.boxConvex=function(e,t,o,i,n,a,r,s){e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,t,o,i,n,a,r,s,e,t)},i.prototype[r.types.BOX|r.types.PARTICLE]=i.prototype.boxParticle=function(e,t,o,i,n,a,r,s){e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexParticle(e.convexPolyhedronRepresentation,t,o,i,n,a,r,s,e,t)},i.prototype[r.types.SPHERE]=i.prototype.sphereSphere=function(e,t,o,i,n,a,s,l){var p=this.createContactEquation(s,l,e,t);i.vsub(o,p.ni),p.ni.normalize(),p.ri.copy(p.ni),p.rj.copy(p.ni),p.ri.mult(e.radius,p.ri),p.rj.mult(-t.radius,p.rj),p.ri.vadd(o,p.ri),p.ri.vsub(s.position,p.ri),p.rj.vadd(i,p.rj),p.rj.vsub(l.position,p.rj),this.result.push(p),this.createFrictionEquationsFromContact(p,this.frictionResult)};var C=new l,z=new l,w=new l;i.prototype[r.types.PLANE|r.types.TRIMESH]=i.prototype.planeTrimesh=function(e,t,o,n,a,s,p,c){var u=new l,y=C;y.set(0,0,1),a.vmult(y,y);for(var h=0;h<t.vertices.length/3;h++){t.getVertex(h,u);var i=new l;i.copy(u),d.pointToWorldFrame(n,s,i,u);var m=z;u.vsub(o,m);var x=y.dot(m);if(0>=x){var g=this.createContactEquation(p,c,e,t);g.ni.copy(y);var r=w;y.scale(m.dot(y),r),u.vsub(r,r),g.ri.copy(r),g.ri.vsub(p.position,g.ri),g.rj.copy(u),g.rj.vsub(c.position,g.rj),this.result.push(g),this.createFrictionEquationsFromContact(g,this.frictionResult)}}};var R=new l,q=new l,F=new l,P=new l,T=new l,V=new l,I=new l,L=new l,W=new l,M=new l,k=new l,j=new l,O=new l,_=new l,D=new a,H=[];i.prototype[r.types.SPHERE|r.types.TRIMESH]=i.prototype.sphereTrimesh=function(e,t,o,n,a,l,p,c){var u=V,y=I,h=L,m=W,x=M,g=k,b=D,f=T,B=q,S=H;d.pointToLocalFrame(n,l,o,x);var E=e.radius;b.lowerBound.set(x.x-E,x.y-E,x.z-E),b.upperBound.set(x.x+E,x.y+E,x.z+E),t.getTrianglesInAABB(b,S);for(var A=P,v=e.radius*e.radius,C=0;C<S.length;C++)for(var i=0;3>i;i++)if(t.getVertex(t.indices[3*S[C]+i],A),A.vsub(x,B),B.norm2()<=v){f.copy(A),d.pointToWorldFrame(n,l,f,A),A.vsub(o,B);var z=this.createContactEquation(p,c,e,t);z.ni.copy(B),z.ni.normalize(),z.ri.copy(z.ni),z.ri.scale(e.radius,z.ri),z.ri.vadd(o,z.ri),z.ri.vsub(p.position,z.ri),z.rj.copy(A),z.rj.vsub(c.position,z.rj),this.result.push(z),this.createFrictionEquationsFromContact(z,this.frictionResult)}for(var C=0;C<S.length;C++)for(var i=0;3>i;i++){t.getVertex(t.indices[3*S[C]+i],u),t.getVertex(t.indices[3*S[C]+(i+1)%3],y),y.vsub(u,h),x.vsub(y,g);var r=g.dot(h);x.vsub(u,g);var w=g.dot(h);if(0<w&&0>r){x.vsub(u,g),m.copy(h),m.normalize(),w=g.dot(m),m.scale(w,g),g.vadd(u,g);var F=g.distanceTo(x);if(F<e.radius){var z=this.createContactEquation(p,c,e,t);g.vsub(x,z.ni),z.ni.normalize(),z.ni.scale(e.radius,z.ri),d.pointToWorldFrame(n,l,g,g),g.vsub(c.position,z.rj),d.vectorToWorldFrame(l,z.ni,z.ni),d.vectorToWorldFrame(l,z.ri,z.ri),this.result.push(z),this.createFrictionEquationsFromContact(z,this.frictionResult)}}}for(var U=j,G=O,Y=_,Q=R,C=0,X=S.length;C!==X;C++){t.getTriangleVertices(S[C],U,G,Y),t.getNormal(S[C],Q),x.vsub(U,g);var F=g.dot(Q);if(Q.scale(F,g),x.vsub(g,g),F=g.distanceTo(x),s.pointInTriangle(g,U,G,Y)&&F<e.radius){var z=this.createContactEquation(p,c,e,t);g.vsub(x,z.ni),z.ni.normalize(),z.ni.scale(e.radius,z.ri),d.pointToWorldFrame(n,l,g,g),g.vsub(c.position,z.rj),d.vectorToWorldFrame(l,z.ni,z.ni),d.vectorToWorldFrame(l,z.ri,z.ri),this.result.push(z),this.createFrictionEquationsFromContact(z,this.frictionResult)}}S.length=0};var N=new l,U=new l;i.prototype[r.types.SPHERE|r.types.PLANE]=i.prototype.spherePlane=function(e,t,o,i,n,a,s,l){var p=this.createContactEquation(s,l,e,t);if(p.ni.set(0,0,1),a.vmult(p.ni,p.ni),p.ni.negate(p.ni),p.ni.normalize(),p.ni.mult(e.radius,p.ri),o.vsub(i,N),p.ni.mult(p.ni.dot(N),U),N.vsub(U,p.rj),-N.dot(p.ni)<=e.radius){var r=p.ri,d=p.rj;r.vadd(o,r),r.vsub(s.position,r),d.vadd(i,d),d.vsub(l.position,d),this.result.push(p),this.createFrictionEquationsFromContact(p,this.frictionResult)}};var G=new l,Y=new l,Q=new l,X=new l,Z=new l,K=new l,J=new l,$=[new l,new l,new l,new l,new l,new l],ee=new l,te=new l,oe=new l,ie=new l;i.prototype[r.types.SPHERE|r.types.BOX]=i.prototype.sphereBox=function(e,t,o,i,n,a,s,d){var c=this.v3pool,u=$;o.vsub(i,X),t.getSideNormals(u,a);for(var y=e.radius,m=!1,x=te,g=oe,v=ie,b=null,f=0,B=0,S=0,E=null,A=0,C=u.length,z;A!==C&&!1==m;A++){z=Z,z.copy(u[A]);var w=z.norm();z.normalize();var h=X.dot(z);if(h<w+y&&0<h){var q=K,F=J;q.copy(u[(A+1)%3]),F.copy(u[(A+2)%3]);var P=q.norm(),T=F.norm();q.normalize(),F.normalize();var V=X.dot(q),I=X.dot(F);if(V<P&&V>-P&&I<T&&I>-T){var L=p(h-w-y);(null==E||L<E)&&(E=L,B=V,S=I,b=w,x.copy(z),g.copy(q),v.copy(F),f++)}}}if(f){m=!0;var W=this.createContactEquation(s,d,e,t);x.mult(-y,W.ri),W.ni.copy(x),W.ni.negate(W.ni),x.mult(b,x),g.mult(B,g),x.vadd(g,x),v.mult(S,v),x.vadd(v,W.rj),W.ri.vadd(o,W.ri),W.ri.vsub(s.position,W.ri),W.rj.vadd(i,W.rj),W.rj.vsub(d.position,W.rj),this.result.push(W),this.createFrictionEquationsFromContact(W,this.frictionResult)}for(var r=c.get(),N=ee,M=0;2!==M&&!m;M++)for(var j=0;2!==j&&!m;j++)for(var k=0;2!==k&&!m;k++)if(r.set(0,0,0),M?r.vadd(u[0],r):r.vsub(u[0],r),j?r.vadd(u[1],r):r.vsub(u[1],r),k?r.vadd(u[2],r):r.vsub(u[2],r),i.vadd(r,N),N.vsub(o,N),N.norm2()<y*y){m=!0;var W=this.createContactEquation(s,d,e,t);W.ri.copy(N),W.ri.normalize(),W.ni.copy(W.ri),W.ri.mult(y,W.ri),W.rj.copy(r),W.ri.vadd(o,W.ri),W.ri.vsub(s.position,W.ri),W.rj.vadd(i,W.rj),W.rj.vsub(d.position,W.rj),this.result.push(W),this.createFrictionEquationsFromContact(W,this.frictionResult)}c.release(r),r=null;for(var l=c.get(),O=c.get(),W=c.get(),_=c.get(),L=c.get(),D=u.length,M=0;M!==D&&!m;M++)for(var j=0;j!==D&&!m;j++)if(M%3!=j%3){u[j].cross(u[M],l),l.normalize(),u[M].vadd(u[j],O),W.copy(o),W.vsub(O,W),W.vsub(i,W);var H=W.dot(l);l.mult(H,_);for(var k=0;k===M%3||k===j%3;)k++;L.copy(o),L.vsub(_,L),L.vsub(O,L),L.vsub(i,L);var U=p(H),G=L.norm();if(U<u[k].norm()&&G<y){m=!0;var Y=this.createContactEquation(s,d,e,t);O.vadd(_,Y.rj),Y.rj.copy(Y.rj),L.negate(Y.ni),Y.ni.normalize(),Y.ri.copy(Y.rj),Y.ri.vadd(i,Y.ri),Y.ri.vsub(o,Y.ri),Y.ri.normalize(),Y.ri.mult(y,Y.ri),Y.ri.vadd(o,Y.ri),Y.ri.vsub(s.position,Y.ri),Y.rj.vadd(i,Y.rj),Y.rj.vsub(d.position,Y.rj),this.result.push(Y),this.createFrictionEquationsFromContact(Y,this.frictionResult)}}c.release(l,O,W,_,L)};var ne=new l,ae=new l,re=new l,se=new l,le=new l,pe=new l,de=new l,ce=new l,ue=new l,ye=new l;i.prototype[r.types.SPHERE|r.types.CONVEXPOLYHEDRON]=i.prototype.sphereConvex=function(e,t,o,a,s,l,d,c){var u=this.v3pool;o.vsub(a,ne);for(var y=t.faceNormals,h=t.faces,m=t.vertices,x=e.radius,g=0;g!==m.length;g++){var i=m[g],v=le;l.vmult(i,v),a.vadd(v,v);var b=se;if(v.vsub(o,b),b.norm2()<x*x){r=!0;var f=this.createContactEquation(d,c,e,t);return f.ri.copy(b),f.ri.normalize(),f.ni.copy(f.ri),f.ri.mult(x,f.ri),v.vsub(a,f.rj),f.ri.vadd(o,f.ri),f.ri.vsub(d.position,f.ri),f.rj.vadd(a,f.rj),f.rj.vsub(c.position,f.rj),this.result.push(f),void this.createFrictionEquationsFromContact(f,this.frictionResult)}}for(var r=!1,g=0,B=h.length;g!==B&&!1==r;g++){var S=y[g],E=h[g],A=pe;l.vmult(S,A);var C=de;l.vmult(m[E[0]],C),C.vadd(a,C);var z=ce;A.mult(-x,z),o.vadd(z,z);var w=ue;z.vsub(C,w);var q=w.dot(A),F=ye;if(o.vsub(C,F),0>q&&0<F.dot(A)){for(var P=[],T=0,V=E.length,j;T!==V;T++)j=u.get(),l.vmult(m[E[T]],j),a.vadd(j,j),P.push(j);if(n(P,A,o)){r=!0;var f=this.createContactEquation(d,c,e,t);A.mult(-x,f.ri),A.negate(f.ni);var I=u.get();A.mult(-q,I);var L=u.get();A.mult(-x,L),o.vsub(a,f.rj),f.rj.vadd(L,f.rj),f.rj.vadd(I,f.rj),f.rj.vadd(a,f.rj),f.rj.vsub(c.position,f.rj),f.ri.vadd(o,f.ri),f.ri.vsub(d.position,f.ri),u.release(I),u.release(L),this.result.push(f),this.createFrictionEquationsFromContact(f,this.frictionResult);for(var T=0,W=P.length;T!==W;T++)u.release(P[T]);return}for(var T=0;T!==E.length;T++){var N=u.get(),M=u.get();l.vmult(m[E[(T+1)%E.length]],N),l.vmult(m[E[(T+2)%E.length]],M),a.vadd(N,N),a.vadd(M,M);var k=ae;M.vsub(N,k);var O=re;k.unit(O);var _=u.get(),p=u.get();o.vsub(N,p);var D=p.dot(O);O.mult(D,_),_.vadd(N,_);var H=u.get();if(_.vsub(o,H),0<D&&D*D<k.norm2()&&H.norm2()<x*x){var f=this.createContactEquation(d,c,e,t);_.vsub(a,f.rj),_.vsub(o,f.ni),f.ni.normalize(),f.ni.mult(x,f.ri),f.rj.vadd(a,f.rj),f.rj.vsub(c.position,f.rj),f.ri.vadd(o,f.ri),f.ri.vsub(d.position,f.ri),this.result.push(f),this.createFrictionEquationsFromContact(f,this.frictionResult);for(var T=0,W=P.length;T!==W;T++)u.release(P[T]);return u.release(N),u.release(M),u.release(_),u.release(H),void u.release(p)}u.release(N),u.release(M),u.release(_),u.release(H),u.release(p)}for(var T=0,W=P.length;T!==W;T++)u.release(P[T])}}};var he=new l,me=new l;i.prototype[r.types.PLANE|r.types.BOX]=i.prototype.planeBox=function(e,t,o,i,n,a,r,s){t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.planeConvex(e,t.convexPolyhedronRepresentation,o,i,n,a,r,s)};var xe=new l,ge=new l,ve=new l,be=new l;i.prototype[r.types.PLANE|r.types.CONVEXPOLYHEDRON]=i.prototype.planeConvex=function(e,t,o,n,a,s,l,p){var d=xe,c=ge;c.set(0,0,1),a.vmult(c,c);for(var u=0,y=ve,h=0;h!==t.vertices.length;h++){d.copy(t.vertices[h]),s.vmult(d,d),n.vadd(d,d),d.vsub(o,y);var i=c.dot(y);if(0>=i){var m=this.createContactEquation(l,p,e,t),r=be;c.mult(c.dot(y),r),d.vsub(r,r),r.vsub(o,m.ri),m.ni.copy(c),d.vsub(n,m.rj),m.ri.vadd(o,m.ri),m.ri.vsub(l.position,m.ri),m.rj.vadd(n,m.rj),m.rj.vsub(p.position,m.rj),this.result.push(m),u++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(m,this.frictionResult)}}this.enableFrictionReduction&&u&&this.createFrictionFromAverage(u)};var fe=new l,Be=new l;i.prototype[r.types.CONVEXPOLYHEDRON]=i.prototype.convexConvex=function(e,t,o,i,n,a,s,l,p,d,c,u){var y=fe;if(!(o.distanceTo(i)>e.boundingSphereRadius+t.boundingSphereRadius)&&e.findSeparatingAxis(t,o,n,i,a,y,c,u)){var h=[],m=Be;e.clipAgainstHull(o,n,t,i,a,y,-100,100,h);for(var x=0,g=0;g!==h.length;g++){var v=this.createContactEquation(s,l,e,t,p,d),r=v.ri,b=v.rj;y.negate(v.ni),h[g].normal.negate(m),m.mult(h[g].depth,m),h[g].point.vadd(m,r),b.copy(h[g].point),r.vsub(o,r),b.vsub(i,b),r.vadd(o,r),r.vsub(s.position,r),b.vadd(i,b),b.vsub(l.position,b),this.result.push(v),x++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(v,this.frictionResult)}this.enableFrictionReduction&&x&&this.createFrictionFromAverage(x)}};var Se=new l,Ee=new l,Ae=new l;i.prototype[r.types.PLANE|r.types.PARTICLE]=i.prototype.planeParticle=function(e,t,o,i,n,a,s,l){var p=Se;p.set(0,0,1),s.quaternion.vmult(p,p);var d=Ee;i.vsub(s.position,d);var c=p.dot(d);if(0>=c){var u=this.createContactEquation(l,s,t,e);u.ni.copy(p),u.ni.negate(u.ni),u.ri.set(0,0,0);var r=Ae;p.mult(p.dot(i),r),i.vsub(r,r),u.rj.copy(r),this.result.push(u),this.createFrictionEquationsFromContact(u,this.frictionResult)}};var Ce=new l;i.prototype[r.types.PARTICLE|r.types.SPHERE]=i.prototype.sphereParticle=function(e,t,o,i,n,a,s,l){var p=Ce;p.set(0,0,1),i.vsub(o,p);var d=p.norm2();if(d<=e.radius*e.radius){var c=this.createContactEquation(l,s,t,e);p.normalize(),c.rj.copy(p),c.rj.mult(e.radius,c.rj),c.ni.copy(p),c.ni.negate(c.ni),c.ri.set(0,0,0),this.result.push(c),this.createFrictionEquationsFromContact(c,this.frictionResult)}};var ze=new y,we=new l,Re=new l,qe=new l,Fe=new l,Pe=new l;i.prototype[r.types.PARTICLE|r.types.CONVEXPOLYHEDRON]=i.prototype.convexParticle=function(e,t,o,n,a,s,l,d){var c=-1,u=qe,y=Pe,h=null,m=0,x=we;if(x.copy(n),x.vsub(o,x),a.conjugate(ze),ze.vmult(x,x),e.pointIsInside(x)){e.worldVerticesNeedsUpdate&&e.computeWorldVertices(o,a),e.worldFaceNormalsNeedsUpdate&&e.computeWorldFaceNormals(a);for(var g=0,i=e.faces.length;g!==i;g++){var v=[e.worldVertices[e.faces[g][0]]],b=e.worldFaceNormals[g];n.vsub(v[0],Fe);var f=-b.dot(Fe);(null==h||p(f)<p(h))&&(h=f,c=g,u.copy(b),m++)}if(-1!==c){var B=this.createContactEquation(d,l,t,e);u.mult(h,y),y.vadd(n,y),y.vsub(o,y),B.rj.copy(y),u.negate(B.ni),B.ri.set(0,0,0);var r=B.ri,S=B.rj;r.vadd(n,r),r.vsub(d.position,r),S.vadd(o,S),S.vsub(l.position,S),this.result.push(B),this.createFrictionEquationsFromContact(B,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}},i.prototype[r.types.BOX|r.types.HEIGHTFIELD]=i.prototype.boxHeightfield=function(e,t,o,i,n,a,r,s){e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexHeightfield(e.convexPolyhedronRepresentation,t,o,i,n,a,r,s)};var Te=new l,Ve=new l,je=[0];i.prototype[r.types.CONVEXPOLYHEDRON|r.types.HEIGHTFIELD]=i.prototype.convexHeightfield=function(e,o,n,a,r,s,l,p){var u=o.data,y=o.elementSize,h=e.boundingSphereRadius,m=Ve,x=je,g=Te;d.pointToLocalFrame(a,s,n,g);var v=t((g.x-h)/y)-1,b=c((g.x+h)/y)+1,f=t((g.y-h)/y)-1,B=c((g.y+h)/y)+1;if(!(0>b||0>B||v>u.length||f>u[0].length)){0>v&&(v=0),0>b&&(b=0),0>f&&(f=0),0>B&&(B=0),v>=u.length&&(v=u.length-1),b>=u.length&&(b=u.length-1),B>=u[0].length&&(B=u[0].length-1),f>=u[0].length&&(f=u[0].length-1);var S=[];o.getRectMinMax(v,f,b,B,S);var E=S[0],A=S[1];if(!(g.z-h>A||g.z+h<E))for(var C=v;C<b;C++)for(var i=f;i<B;i++)o.getConvexTrianglePillar(C,i,!1),d.pointToWorldFrame(a,s,o.pillarOffset,m),n.distanceTo(m)<o.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&this.convexConvex(e,o.pillarConvex,n,m,r,s,l,p,null,null,x,null),o.getConvexTrianglePillar(C,i,!0),d.pointToWorldFrame(a,s,o.pillarOffset,m),n.distanceTo(m)<o.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&this.convexConvex(e,o.pillarConvex,n,m,r,s,l,p,null,null,x,null)}};var Ie=new l,Le=new l;i.prototype[r.types.SPHERE|r.types.HEIGHTFIELD]=i.prototype.sphereHeightfield=function(e,o,n,a,r,s,l,p){var u=o.data,y=e.radius,h=o.elementSize,m=Le,x=Ie;d.pointToLocalFrame(a,s,n,x);var g=t((x.x-y)/h)-1,v=c((x.x+y)/h)+1,b=t((x.y-y)/h)-1,f=c((x.y+y)/h)+1;if(!(0>v||0>f||g>u.length||f>u[0].length)){0>g&&(g=0),0>v&&(v=0),0>b&&(b=0),0>f&&(f=0),g>=u.length&&(g=u.length-1),v>=u.length&&(v=u.length-1),f>=u[0].length&&(f=u[0].length-1),b>=u[0].length&&(b=u[0].length-1);var B=[];o.getRectMinMax(g,b,v,f,B);var S=B[0],E=B[1];if(!(x.z-y>E||x.z+y<S))for(var A=this.result,C=g;C<v;C++)for(var i=b,z;i<f;i++){z=A.length,o.getConvexTrianglePillar(C,i,!1),d.pointToWorldFrame(a,s,o.pillarOffset,m),n.distanceTo(m)<o.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&this.sphereConvex(e,o.pillarConvex,n,m,r,s,l,p),o.getConvexTrianglePillar(C,i,!0),d.pointToWorldFrame(a,s,o.pillarOffset,m),n.distanceTo(m)<o.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&this.sphereConvex(e,o.pillarConvex,n,m,r,s,l,p);var w=A.length-z;if(2<w)return}}}},{"../collision/AABB":3,"../collision/Ray":9,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43,"../solver/Solver":47,"../utils/Vec3Pool":54}],56:[function(e,o){function i(){h.apply(this),this.dt=-1,this.allowSleep=!1,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=0,this.quatNormalizeFast=!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new a,this.broadphase=new E,this.bodies=[],this.solver=new s,this.constraints=[],this.narrowphase=new u(this),this.collisionMatrix=new m,this.collisionMatrixPrevious=new m,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new v,this.defaultMaterial=new x("default"),this.defaultContactMaterial=new g(this.defaultMaterial,this.defaultMaterial,{friction:0.3,restitution:0}),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null}}o.exports=i;var n=e("../shapes/Shape"),a=e("../math/Vec3"),r=e("../math/Quaternion"),s=e("../solver/GSSolver"),p=e("../utils/Vec3Pool"),d=e("../equations/ContactEquation"),c=e("../equations/FrictionEquation"),u=e("./Narrowphase"),h=e("../utils/EventTarget"),m=e("../collision/ArrayCollisionMatrix"),x=e("../material/Material"),g=e("../material/ContactMaterial"),B=e("../objects/Body"),v=e("../utils/TupleDictionary"),b=e("../collision/RaycastResult"),f=e("../collision/AABB"),S=e("../collision/Ray"),E=e("../collision/NaiveBroadphase");i.prototype=new h;var A=new f,C=new S;if(i.prototype.getContactMaterial=function(e,t){return this.contactMaterialTable.get(e.id,t.id)},i.prototype.numObjects=function(){return this.bodies.length},i.prototype.collisionMatrixTick=function(){var e=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=e,this.collisionMatrix.reset()},i.prototype.add=i.prototype.addBody=function(e){-1!==this.bodies.indexOf(e)||(e.index=this.bodies.length,this.bodies.push(e),e.world=this,e.initPosition.copy(e.position),e.initVelocity.copy(e.velocity),e.timeLastSleepy=this.time,e instanceof B&&(e.initAngularVelocity.copy(e.angularVelocity),e.initQuaternion.copy(e.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=e,this.dispatchEvent(this.addBodyEvent))},i.prototype.addConstraint=function(e){this.constraints.push(e)},i.prototype.removeConstraint=function(e){var t=this.constraints.indexOf(e);-1!==t&&this.constraints.splice(t,1)},i.prototype.rayTest=function(e,t,o){o instanceof b?this.raycastClosest(e,t,{skipBackfaces:!0},o):this.raycastAll(e,t,{skipBackfaces:!0},o)},i.prototype.raycastAll=function(e,t,o,i){return o.mode=S.ALL,o.from=e,o.to=t,o.callback=i,C.intersectWorld(this,o)},i.prototype.raycastAny=function(e,t,o,i){return o.mode=S.ANY,o.from=e,o.to=t,o.result=i,C.intersectWorld(this,o)},i.prototype.raycastClosest=function(e,t,o,i){return o.mode=S.CLOSEST,o.from=e,o.to=t,o.result=i,C.intersectWorld(this,o)},i.prototype.remove=function(e){e.world=null;var t=this.bodies.length-1,o=this.bodies,n=o.indexOf(e);if(-1!==n){o.splice(n,1);for(var a=0;a!==o.length;a++)o[a].index=a;this.collisionMatrix.setNumObjects(t),this.removeBodyEvent.body=e,this.dispatchEvent(this.removeBodyEvent)}},i.prototype.removeBody=i.prototype.remove,i.prototype.addMaterial=function(e){this.materials.push(e)},i.prototype.addContactMaterial=function(e){this.contactmaterials.push(e),this.contactMaterialTable.set(e.materials[0].id,e.materials[1].id,e)},"undefined"==typeof performance&&(performance={}),!performance.now){var z=Date.now();performance.timing&&performance.timing.navigationStart&&(z=performance.timing.navigationStart),performance.now=function(){return Date.now()-z}}var w=new a;i.prototype.step=function(e,o,n){if(n=n||10,o=o||0,0===o)this.internalStep(e),this.time+=e;else{var a=t((this.time+o)/e)-t(this.time/e);a=l(a,n);for(var r=performance.now(),s=0;s!==a&&(this.internalStep(e),!(performance.now()-r>1e3*e));s++);this.time+=o;for(var i=this.time%e,p=w,d=this.bodies,c=0,u;c!==d.length;c++)u=d[c],u.type!==B.STATIC&&u.sleepState!==B.SLEEPING?(u.position.vsub(u.previousPosition,p),p.scale(i/e,p),u.position.vadd(p,u.interpolatedPosition)):(u.interpolatedPosition.copy(u.position),u.interpolatedQuaternion.copy(u.quaternion))}};var R={type:"postStep"},q={type:"preStep"},F={type:"collide",body:null,contact:null},P=[],T=[],V=[],I=[],j=new a,L=new a,W=new a,N=new a,M=new a,k=new a,O=new a,_=new a,D=new a,H=new r,U=new r,G=new r,Y=new a;i.prototype.internalStep=function(e){this.dt=e;var t=this,o=this,a=this.contacts,r=V,s=I,l=this.numObjects(),p=this.bodies,d=this.solver,u=this.gravity,h=this.doProfiling,x=this.profile,g=B.DYNAMIC,S=this.constraints,E=T,A=u.norm(),C=u.x,z=u.y,L=u.z,W=0,i;for(h&&(i=performance.now()),W=0;W!==l;W++){var N=p[W];if(N.type&g){var M=N.force,f=N.mass;M.x+=f*C,M.y+=f*z,M.z+=f*L}}for(var W=0,m=this.subsystems.length;W!==m;W++)this.subsystems[W].update();h&&(i=performance.now()),r.length=0,s.length=0,this.broadphase.collisionPairs(this,r,s),h&&(x.broadphase=performance.now()-i);var O=S.length;for(W=0;W!==O;W++){var _=S[W];if(!_.collideConnected)for(var c=r.length-1;0<=c;c-=1)(_.bodyA===r[c]&&_.bodyB===s[c]||_.bodyB===r[c]&&_.bodyA===s[c])&&(r.splice(c,1),s.splice(c,1))}this.collisionMatrixTick(),h&&(i=performance.now());var j=P,D=a.length;for(W=0;W!==D;W++)j.push(a[W]);a.length=0;var H=this.frictionEquations.length;for(W=0;W!==H;W++)E.push(this.frictionEquations[W]);this.frictionEquations.length=0,this.narrowphase.getContacts(r,s,this,a,j,this.frictionEquations,E),h&&(x.narrowphase=performance.now()-i),h&&(i=performance.now());for(var W=0;W<this.frictionEquations.length;W++)d.addEquation(this.frictionEquations[W]);for(var Q=a.length,X=0;X!==Q;X++){var _=a[X],N=_.bi,k=_.bj,Z=_.si,K=_.sj,J;J=N.material&&k.material?this.getContactMaterial(N.material,k.material)||this.defaultContactMaterial:this.defaultContactMaterial;var $=J.friction;if(N.material&&k.material&&(0<=N.material.friction&&0<=k.material.friction&&($=N.material.friction*k.material.friction),0<=N.material.restitution&&0<=k.material.restitution&&(_.restitution=N.material.restitution*k.material.restitution)),d.addEquation(_),N.allowSleep&&N.type===B.DYNAMIC&&N.sleepState===B.SLEEPING&&k.sleepState===B.AWAKE&&k.type!==B.STATIC){var ee=k.velocity.norm2()+k.angularVelocity.norm2(),te=y(k.sleepSpeedLimit,2);ee>=2*te&&(N._wakeUpAfterNarrowphase=!0)}if(k.allowSleep&&k.type===B.DYNAMIC&&k.sleepState===B.SLEEPING&&N.sleepState===B.AWAKE&&N.type!==B.STATIC){var oe=N.velocity.norm2()+N.angularVelocity.norm2(),ie=y(N.sleepSpeedLimit,2);oe>=2*ie&&(k._wakeUpAfterNarrowphase=!0)}this.collisionMatrix.set(N,k,!0),this.collisionMatrixPrevious.get(N,k)||(F.body=k,F.contact=_,N.dispatchEvent(F),F.body=N,k.dispatchEvent(F))}for(h&&(x.makeContactConstraints=performance.now()-i,i=performance.now()),W=0;W!==l;W++){var N=p[W];N._wakeUpAfterNarrowphase&&(N.wakeUp(),N._wakeUpAfterNarrowphase=!1)}var O=S.length;for(W=0;W!==O;W++){var _=S[W];_.update();for(var c=0,ne=_.equations.length,ae;c!==ne;c++)ae=_.equations[c],d.addEquation(ae)}d.solve(e,this),h&&(x.solve=performance.now()-i),d.removeAllEquations();var re=y;for(W=0;W!==l;W++){var N=p[W];if(N.type&g){var se=re(1-N.linearDamping,e),le=N.velocity;le.mult(se,le);var v=N.angularVelocity;if(v){var pe=re(1-N.angularDamping,e);v.mult(pe,v)}}}for(this.dispatchEvent(q),W=0;W!==l;W++){var N=p[W];N.preStep&&N.preStep.call(N)}h&&(i=performance.now());var de=U,w=G,ce=this.stepnumber,ue=B.DYNAMIC|B.KINEMATIC,ye=0==ce%(this.quatNormalizeSkip+1),he=this.quatNormalizeFast,me=0.5*e,xe=n.types.PLANE,ge=n.types.CONVEXPOLYHEDRON;for(W=0;W!==l;W++){var ve=p[W],b=ve.force,be=ve.torque;if(ve.type&ue&&ve.sleepState!==B.SLEEPING){var fe=ve.velocity,Be=ve.angularVelocity,Se=ve.position,Ee=ve.quaternion,Ae=ve.invMass,Ce=ve.invInertiaWorld;fe.x+=b.x*Ae*e,fe.y+=b.y*Ae*e,fe.z+=b.z*Ae*e,ve.angularVelocity&&(Ce.vmult(be,Y),Y.mult(e,Y),Y.vadd(Be,Be)),Se.x+=fe.x*e,Se.y+=fe.y*e,Se.z+=fe.z*e,ve.angularVelocity&&(de.set(Be.x,Be.y,Be.z,0),de.mult(Ee,w),Ee.x+=me*w.x,Ee.y+=me*w.y,Ee.z+=me*w.z,Ee.w+=me*w.w,ye&&(he?Ee.normalizeFast():Ee.normalize())),ve.aabb&&(ve.aabbNeedsUpdate=!0),ve.updateInertiaWorld&&ve.updateInertiaWorld()}}for(this.clearForces(),this.broadphase.dirty=!0,h&&(x.integrate=performance.now()-i),this.time+=e,this.stepnumber+=1,this.dispatchEvent(R),W=0;W!==l;W++){var N=p[W],ze=N.postStep;ze&&ze.call(N)}if(this.allowSleep)for(W=0;W!==l;W++)p[W].sleepTick(this.time)},i.prototype.clearForces=function(){for(var e=this.bodies,t=e.length,o=0;o!==t;o++){var i=e[o],n=i.force,a=i.torque;i.force.set(0,0,0),i.torque.set(0,0,0)}}},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/Ray":9,"../collision/RaycastResult":10,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../material/ContactMaterial":24,"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Shape":43,"../solver/GSSolver":46,"../utils/EventTarget":49,"../utils/TupleDictionary":52,"../utils/Vec3Pool":54,"./Narrowphase":55}]},{},[2])(2)})}),i=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},n=function(){function e(e,t){for(var o=0,i;o<t.length;o++)i=t[o],i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}return function(t,o,i){return o&&e(t.prototype,o),i&&e(t,i),t}}(),r=function(){function e(t){var o=this;i(this,e),this.send=t,this.physics=new a.World,this.bodyIDs=[],this.bodyDB={},this.springs=[],this.output=[],this.physics.broadphase=new a.NaiveBroadphase,this.physics.solver.iterations=10,this.physics.addEventListener("postStep",function(){for(var e=0;e<o.springs.length;++e)o.springs[e].applyForce()})}return n(e,[{key:"update",value:function(t){this.physics.step(e.DT,t)}},{key:"setAllowSleep",value:function(e){this.physics.allowSleep=e}},{key:"setGravity",value:function(e){this.physics.gravity.set(0,e,0)}},{key:"sleepBody",value:function(){}},{key:"getBody",value:function(e){var t=this.bodyDB[e];return t?(t.sleepState===a.Body.SLEEPING&&t.wakeUp(),t):void console.error("Don't recognize body",e)}},{key:"newBody",value:function(e,t,o){var i=new a.Body({mass:t,type:o,allowSleep:!0,sleepSpeedLimit:0.1,sleepTimeLimit:1});i.addEventListener("sleep",this.sleepBody.bind(this)),this.bodyIDs.push(e),this.bodyDB[e]=i,this.physics.addBody(i)}},{key:"addSphere",value:function(e,t){var o=this.getBody(e);o.addShape(new a.Sphere(t))}},{key:"addBox",value:function(e,t,o,i){var n=this.getBody(e);n.addShape(new a.Box(new a.Vec3(t,o,i)))}},{key:"addPlane",value:function(e){var t=this.getBody(e);t.addShape(new a.Plane)}},{key:"setPosition",value:function(e,t,o,i){var n=this.getBody(e);n.position.set(t,o,i)}},{key:"setQuaternion",value:function(e,t,o,i,n){var a=this.getBody(e);a.quaternion.set(t,o,i,n)}},{key:"setVelocity",value:function(e,t,o,i){var n=this.getBody(e);n.velocity.set(t,o,i)}},{key:"setAngularVelocity",value:function(e,t,o,i){var n=this.getBody(e);n.angularVelocity.set(t,o,i)}},{key:"setLinearDamping",value:function(e,t){var o=this.getBody(e);o.linearDamping=t}},{key:"setAngularDamping",value:function(e,t){var o=this.getBody(e);o.angularDamping=t}},{key:"addSpring",value:function(e,t,o,i,n){var r=this.getBody(e),s=this.getBody(t);this.springs.push(new a.Spring(bodyA,bodyB,{restLength:o,stiffness:i,damping:n}))}}]),e}();r.DT=0.01;var s=1e3*r.DT,l=new r,p=[],d=null,c=null;onmessage=function(e){if("start"===e.data)null==c&&(d=performance.now(),c=setInterval(o,s),console.log("worker timer started",s));else if("stop"===e.data)null!==c&&(clearInterval(c),c=null,console.log("worker timer stopped"));else for(var i=e.data,n;0<i.length;)if(n=i.indexOf("END"),0<n){var a=i.splice(0,n);t(l,a)}else i.shift()}});
